<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FitLife">
  <meta name="theme-color" content="#090909">
  <title>FitLife</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{height:100%;height:-webkit-fill-available;background:#090909}
    body{min-height:100vh;min-height:-webkit-fill-available;background:#090909;overflow:hidden;font-family:-apple-system,sans-serif;color:#f0f0f0;-webkit-font-smoothing:antialiased}
    #root{height:100%}
    button,a{touch-action:manipulation}
    .nav{padding-bottom:max(4px,env(safe-area-inset-bottom)) !important}
    #boot{position:fixed;inset:0;background:#090909;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:9999;transition:opacity .4s}
    #boot .icon{font-size:52px}
    #boot .name{font-size:38px;font-weight:900;letter-spacing:4px;color:#c8f135;font-family:impact,sans-serif}
    #boot .sub{font-size:13px;color:#55555f;letter-spacing:.5px}
    #boot .ring{width:32px;height:32px;border-radius:50%;border:2.5px solid #1e1e23;border-top-color:#c8f135;animation:spin .75s linear infinite}
    #err{display:none;position:fixed;inset:0;background:#090909;padding:30px;z-index:9999;overflow:auto}
    #err h2{color:#f55a3f;font-size:20px;margin-bottom:12px}
    #err pre{color:#9090a0;font-size:11px;white-space:pre-wrap;word-break:break-all;line-height:1.6}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="boot">
    <div class="icon">&#x1F4AA;</div>
    <div class="name">FITLIFE</div>
    <div class="sub">Starting up...</div>
    <div class="ring"></div>
  </div>
  <div id="err"><h2>&#x26A0;&#xFE0F; Error</h2><pre id="errmsg"></pre></div>
  <div id="root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

  <script>
    // Surface any JS errors visibly on screen (helpful for mobile debugging)
    window.onerror = function(msg, src, line, col, err) {
      document.getElementById('boot').style.display = 'none';
      var e = document.getElementById('err');
      e.style.display = 'block';
      document.getElementById('errmsg').textContent = (err ? err.stack : '') || msg;
    };
    window.onunhandledrejection = function(e) {
      document.getElementById('boot').style.display = 'none';
      var er = document.getElementById('err');
      er.style.display = 'block';
      document.getElementById('errmsg').textContent = String(e.reason);
    };
  </script>

  <script>
const { useState, useEffect, useRef, useCallback, useMemo } = React;

var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
const STYLE = `
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#090909;--s1:#101012;--s2:#161619;--s3:#1e1e23;--s4:#26262d;
  --border:#2a2a33;--b2:#363640;
  --lime:#c8f135;--ld:rgba(200,241,53,.1);--lb:rgba(200,241,53,.22);
  --blue:#3fb8f5;--bd:rgba(63,184,245,.1);
  --red:#f55a3f;--rd:rgba(245,90,63,.1);
  --amber:#f5a83f;--ad:rgba(245,168,63,.1);
  --purple:#b06af5;--pd:rgba(176,106,245,.1);
  --teal:#3ff5c8;--td:rgba(63,245,200,.1);
  --pink:#f53f8a;--pkd:rgba(245,63,138,.1);
  --text:#f0f0f0;--t2:#9090a0;--t3:#55555f;
  --fd:'Bebas Neue',sans-serif;--fb:'DM Sans',sans-serif;--fm:'DM Mono',monospace;
  --r:14px;--rs:9px;--nav:68px;
}
html,body{height:100%;background:var(--bg)}
body{font-family:var(--fb);color:var(--text);-webkit-font-smoothing:antialiased;overflow:hidden}
#root{height:100%}
.app{max-width:430px;height:100vh;margin:0 auto;display:flex;flex-direction:column;overflow:hidden}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding-bottom:calc(var(--nav)+16px);-webkit-overflow-scrolling:touch}
.main::-webkit-scrollbar{display:none}
.nav{flex-shrink:0;height:var(--nav);background:rgba(16,16,18,.98);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;padding:0 4px 4px;z-index:100}
.nb{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:var(--t3);cursor:pointer;padding:8px;border-radius:var(--rs);transition:color .2s;min-width:54px}
.nb.on{color:var(--lime)}.nb svg{width:20px;height:20px;stroke-width:1.8}
.nb span{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.ph{padding:24px 18px 0}
.ph-title{font-family:var(--fd);font-size:48px;line-height:.92;letter-spacing:1px}
.ph-sub{color:var(--t2);font-size:13px;margin-top:5px}
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin:12px 16px 0}
.clbl{font-size:10px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--t3);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.clbl::after{content:'';flex:1;height:1px;background:var(--border)}
.btn{background:var(--lime);color:#000;border:none;border-radius:var(--rs);padding:11px 18px;font-family:var(--fb);font-weight:700;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:opacity .15s,transform .1s;white-space:nowrap;text-decoration:none}
.btn:active{transform:scale(.96)}
.btn.ghost{background:var(--s4);color:var(--text);border:1px solid var(--b2)}
.btn.red{background:var(--red);color:#fff}.btn.blue{background:var(--blue);color:#000}
.btn.teal{background:var(--teal);color:#000}.btn.amber{background:var(--amber);color:#000}
.btn.pink{background:var(--pink);color:#fff}
.btn.sm{padding:7px 13px;font-size:12px}.btn.xs{padding:5px 9px;font-size:11px}
.btn.full{width:100%;justify-content:center}.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.tabs{display:flex;gap:6px;padding:10px 16px 0;flex-wrap:wrap}
.tab{background:var(--s2);border:1px solid var(--border);border-radius:99px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--t2);cursor:pointer;transition:all .15s}
.tab.on{background:var(--lime);color:#000;border-color:var(--lime)}
.inp{background:var(--s3);border:1px solid var(--border);border-radius:var(--rs);padding:9px 12px;color:var(--text);font-family:var(--fb);font-size:14px;width:100%;outline:none;-webkit-appearance:none;transition:border-color .2s}
.inp:focus{border-color:var(--lime)}
.ilbl{font-size:11px;color:var(--t2);margin-bottom:5px;display:block;font-weight:600}
.ig{margin-bottom:12px}
.mr{display:flex;align-items:center;gap:10px;margin-bottom:8px}.mr:last-child{margin-bottom:0}
.mn{font-size:11px;font-weight:600;width:50px;color:var(--t2)}
.mb{flex:1;height:7px;background:var(--s4);border-radius:99px;overflow:hidden}
.mf{height:100%;border-radius:99px;transition:width .4s ease}
.mv{font-family:var(--fm);font-size:11px;width:78px;text-align:right;color:var(--text)}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 16px 0}
.sc{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px 15px;cursor:pointer}
.sv{font-family:var(--fd);font-size:34px;line-height:1}
.su{font-size:13px;color:var(--t2);margin-left:2px}
.sl{font-size:10px;color:var(--t3);margin-top:4px;letter-spacing:.5px;text-transform:uppercase}
.co{border-radius:var(--r);padding:13px 15px;margin:12px 16px 0;font-size:13px;line-height:1.65}
.co.lime{background:var(--ld);border:1px solid var(--lb)}
.co.blue{background:var(--bd);border:1px solid rgba(63,184,245,.22)}
.co.red{background:var(--rd);border:1px solid rgba(245,90,63,.22)}
.co.amber{background:var(--ad);border:1px solid rgba(245,168,63,.22)}
.co.purple{background:var(--pd);border:1px solid rgba(176,106,245,.22)}
.co.teal{background:var(--td);border:1px solid rgba(63,245,200,.22)}
.co.pink{background:var(--pkd);border:1px solid rgba(245,63,138,.22)}
.er{display:flex;align-items:flex-start;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.er:last-child{border-bottom:none}
.en{font-weight:600;font-size:14px}.ed{font-size:12px;color:var(--t2);margin-top:2px}
.sh{display:grid;grid-template-columns:22px 1fr 1fr auto;gap:7px;margin-bottom:7px}
.sh>span{font-size:9px;color:var(--t3);font-weight:700;text-transform:uppercase;letter-spacing:.8px;text-align:center}
.sr{display:grid;grid-template-columns:22px 1fr 1fr auto;gap:7px;align-items:center;margin-bottom:5px}
.sn{font-family:var(--fm);font-size:12px;color:var(--t3);text-align:center}
.si{background:var(--s4);border:1px solid var(--border);border-radius:6px;padding:7px 5px;color:var(--text);font-family:var(--fm);font-size:13px;width:100%;outline:none;text-align:center;-webkit-appearance:none;transition:border-color .15s}
.si:focus{border-color:var(--lime)}.si.fail{border-color:var(--red);background:var(--rd)}
.sbs{display:flex;gap:3px;justify-content:center}
.sb{width:29px;height:29px;border-radius:6px;border:1.5px solid var(--border);background:var(--s4);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.ov{position:fixed;inset:0;background:rgba(9,9,9,.97);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:300;gap:6px}
.rt{font-family:var(--fd);font-size:88px;line-height:1;color:var(--lime);letter-spacing:3px}
.dm{position:fixed;inset:0;background:rgba(9,9,9,.97);z-index:300;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
.dm-head{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 12px;position:sticky;top:0;background:rgba(9,9,9,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:1}
.dm-title{font-family:var(--fd);font-size:28px;letter-spacing:.5px}
.badge{display:inline-block;border-radius:6px;padding:3px 8px;font-family:var(--fm);font-size:11px}
.badge.lime{background:var(--ld);color:var(--lime);border:1px solid var(--lb)}
.badge.red{background:var(--rd);color:var(--red);border:1px solid rgba(245,90,63,.25)}
.badge.amber{background:var(--ad);color:var(--amber);border:1px solid rgba(245,168,63,.25)}
.badge.blue{background:var(--bd);color:var(--blue);border:1px solid rgba(63,184,245,.25)}
.badge.teal{background:var(--td);color:var(--teal);border:1px solid rgba(63,245,200,.25)}
.badge.purple{background:var(--pd);color:var(--purple);border:1px solid rgba(176,106,245,.25)}
.badge.pink{background:var(--pkd);color:var(--pink);border:1px solid rgba(245,63,138,.25)}
.week{display:flex;gap:6px;overflow-x:auto;padding:12px 16px 0;scrollbar-width:none}
.week::-webkit-scrollbar{display:none}
.dc{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:42px;padding:9px 6px;background:var(--s1);border:1px solid var(--border);border-radius:var(--rs);flex-shrink:0}
.dc.today{border-color:var(--lime)}.dc.trained{background:var(--ld)}
.dn{font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.dd{font-family:var(--fd);font-size:22px;line-height:1}
.dot{width:4px;height:4px;border-radius:50%;background:var(--lime)}
.pb{margin:12px 16px 0;border-radius:var(--r);padding:14px 16px;background:linear-gradient(135deg,var(--s2),rgba(200,241,53,.05));border:1px solid var(--lb);display:flex;align-items:center;gap:14px}
.dlb{margin:12px 16px 0;border-radius:var(--r);padding:14px 16px;background:var(--ad);border:1px solid rgba(245,168,63,.28);display:flex;align-items:flex-start;gap:12px}
.pring{transform:rotate(-90deg)}
.pill{display:inline-block;background:var(--s2);border:1px solid var(--border);border-radius:99px;padding:5px 12px;font-size:12px;font-weight:500;color:var(--t2);margin:3px;cursor:pointer}
.pill:active{background:var(--lime);color:#000;border-color:var(--lime)}
.bubble{background:var(--s2);border-radius:var(--r);border-bottom-left-radius:4px;padding:12px 14px;font-size:13px;line-height:1.65;max-width:88%;margin-bottom:10px}
.bubble.user{background:var(--lime);color:#000;margin-left:auto;border-radius:var(--r);border-bottom-right-radius:4px}
.spin{border:2px solid var(--border);border-top-color:var(--lime);border-radius:50%;animation:sp .7s linear infinite;display:inline-block}
@keyframes sp{to{transform:rotate(360deg)}}
.fade{animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.gap{height:20px}
.prog-modal{position:fixed;inset:0;background:rgba(9,9,9,.97);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:300;padding:24px;gap:10px}
`;
const USER = { age: 56, weightLbs: 198, tdee: 2540, targetCals: 2150, protein: 175, fat: 65, carbs: 190 };
const MAX_HR = 164, HR_LOW = 139, HR_HIGH = 156;
const EX = {
  // ── MAIN LIFTS A ─────────────────────────────────
  bench_press: { name: "Bench Press", cat: "main", muscle: "Chest", sets: 3, rep: [6, 8], rest: 90, weighted: true, solo: true, safetyNote: "Solo \u2014 keep at RPE 7 max. No grinding reps to failure without a spotter.", gif: "https://muscleswiki.com/exercises/chest/barbell-bench-press/", yt: "https://www.youtube.com/watch?v=SCVCLChPQFY", cue: "Drive feet into floor. Slight arch. Bar to lower chest. Control descent." },
  rdl_db: { name: "Romanian Deadlift (DB)", cat: "main", muscle: "Hamstrings/Glutes", sets: 3, rep: [10, 12], rest: 90, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/hamstrings/dumbbell-romanian-deadlift/", yt: "https://www.youtube.com/watch?v=JCXUYuzwNrM", cue: "Hinge at hips, soft knees. Feel hamstring stretch before reversing. Keep bar close." },
  goblet_squat: { name: "Goblet Squat (KB)", cat: "main", muscle: "Quads/Glutes", sets: 3, rep: [12, 15], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/quadriceps/kettlebell-goblet-squat/", yt: "https://www.youtube.com/watch?v=MeIiIdhvXT4", cue: "Elbows inside knees at bottom. Chest tall. Drive knees out. Full depth." },
  turkish_getup: { name: "Turkish Get-Up (KB)", cat: "main", muscle: "Full Body/Core", sets: 3, rep: [3, 5], rest: 90, weighted: true, solo: false, unit: "ea side", gif: "https://muscleswiki.com/exercises/core/kettlebell-turkish-get-up/", yt: "https://www.youtube.com/watch?v=0bWRPC49-KI", cue: "Slow and deliberate every single time. Keep arm vertical. Never rush this one." },
  // ── MAIN LIFTS B ─────────────────────────────────
  clean_deadlift: { name: "Clean Deadlift", cat: "main", muscle: "Full Posterior", sets: 3, rep: [5, 6], rest: 120, weighted: true, solo: true, safetyNote: "Keep weight moderate solo. No max effort without a spotter nearby.", gif: "https://muscleswiki.com/exercises/hamstrings/barbell-deadlift/", yt: "https://www.youtube.com/watch?v=op9kVnSso6Q", cue: "Bar over mid-foot. Big breath and brace. Push the floor away \u2014 not a pull." },
  bulgarian_split: { name: "Bulgarian Split Squat", cat: "main", muscle: "Quads/Glutes", sets: 3, rep: [8, 10], rest: 75, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/quadriceps/dumbbell-bulgarian-split-squat/", yt: "https://www.youtube.com/watch?v=2C-uNgKwPLE", cue: "Rear foot elevated. Upright torso. Front knee tracks toes. ATG depth if possible." },
  kb_swing: { name: "Kettlebell Swing", cat: "main", muscle: "Posterior Chain", sets: 3, rep: [15, 20], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/hamstrings/kettlebell-swing/", yt: "https://www.youtube.com/watch?v=YSxHifyI6s8", cue: "Hinge \u2014 don't squat. Power from hips. Bell floats to shoulder height naturally." },
  incline_bench_db: { name: "Incline Bench Press (DB)", cat: "main", muscle: "Upper Chest", sets: 3, rep: [8, 10], rest: 90, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/chest/dumbbell-incline-bench-press/", yt: "https://www.youtube.com/watch?v=8iPEnn-ltC8", cue: "30\u201345\xB0 incline. Press up and slightly in. Control descent. Stretch at bottom." },
  // ── PUSH ACCESSORIES ─────────────────────────────
  push_diamond: { name: "Diamond Push-Ups", cat: "push", muscle: "Triceps/Chest", sets: 3, rep: [10, 15], rest: 60, weighted: false, solo: false, gif: "https://muscleswiki.com/exercises/triceps/diamond-push-up/", yt: "https://www.youtube.com/watch?v=J0DnG1_S92I", cue: "Hands form diamond under chest. Elbows track back. Full range." },
  push_wide: { name: "Wide-Grip Push-Ups", cat: "push", muscle: "Chest/Shoulders", sets: 3, rep: [12, 15], rest: 60, weighted: false, solo: false, gif: "https://muscleswiki.com/exercises/chest/wide-push-up/", yt: "https://www.youtube.com/watch?v=23OmBdPiCmA", cue: "Hands wider than shoulders. Full ROM. Squeeze chest at top." },
  push_offset: { name: "Offset Push-Ups", cat: "push", muscle: "Unilateral Chest", sets: 3, rep: [8, 10], rest: 60, weighted: false, solo: false, gif: "https://muscleswiki.com/exercises/chest/push-up/", yt: "https://www.youtube.com/watch?v=IODxDxX7oi4", cue: "One hand elevated on a plate or block. Loads one side at a time. Progression toward one-arm." },
  incline_fly: { name: "Incline DB Fly", cat: "push", muscle: "Upper Chest", sets: 3, rep: [12, 15], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/chest/dumbbell-incline-fly/", yt: "https://www.youtube.com/watch?v=eozdVDA78K0", cue: "Slight bend in elbows. Open chest wide. Squeeze at top. Light weight \u2014 feel the stretch." },
  bench_dip: { name: "Bench Dips (Feet Flat)", cat: "push", muscle: "Triceps", sets: 3, rep: [12, 15], rest: 60, weighted: false, solo: false, gif: "https://muscleswiki.com/exercises/triceps/bench-dip/", yt: "https://www.youtube.com/watch?v=c3ZGl4pAwZ4", cue: "Feet flat on floor \u2014 easier on shoulder joint. Lower until 90\xB0 at elbow." },
  skull_crusher: { name: "Skull Crusher (DB)", cat: "push", muscle: "Triceps", sets: 3, rep: [10, 12], rest: 60, weighted: true, solo: true, safetyNote: "Moderate weight only solo. Keep elbows stationary. No grinding reps.", gif: "https://muscleswiki.com/exercises/triceps/dumbbell-skull-crusher/", yt: "https://www.youtube.com/watch?v=d_KZxkY_0cM", cue: "Upper arms vertical. Forearms only move. Control descent. Don't let elbows flare." },
  seated_tri: { name: "Seated Tricep Extension", cat: "push", muscle: "Triceps", sets: 3, rep: [12, 15], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/triceps/dumbbell-seated-tricep-extension/", yt: "https://www.youtube.com/watch?v=_gsUck-7M74", cue: "Both hands on one DB overhead. Elbows close to head. Full extension." },
  cuban_press: { name: "Cuban Press (DB)", cat: "push", muscle: "Shoulder Health", sets: 3, rep: [10, 12], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/shoulders/dumbbell-cuban-press/", yt: "https://www.youtube.com/watch?v=FMgD2zR1D4k", cue: "External rotation then press. Light weight only \u2014 this is shoulder prehab, not a strength move." },
  seated_ohp: { name: "Seated DB Shoulder Press", cat: "push", muscle: "Shoulders", sets: 3, rep: [10, 12], rest: 75, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/shoulders/dumbbell-shoulder-press/", yt: "https://www.youtube.com/watch?v=qEwKCR5JCog", cue: "Moderate weight only (shoulder issue). Stop just short of lockout. Controlled descent." },
  box_jump: { name: "Box Jumps", cat: "push", muscle: "Power/Explosiveness", sets: 3, rep: [5, 8], rest: 90, weighted: false, solo: false, gif: "https://muscleswiki.com/exercises/quadriceps/box-jump/", yt: "https://www.youtube.com/watch?v=hxldG9FMKu4", cue: "Land softly \u2014 absorb into a squat. Step down, never jump down. Knee over toe on landing. ATG prep." },
  // ── PULL ACCESSORIES ─────────────────────────────
  incline_row: { name: "Incline Row (DB)", cat: "pull", muscle: "Back/Rear Delt", sets: 3, rep: [10, 12], rest: 75, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/back/dumbbell-incline-row/", yt: "https://www.youtube.com/watch?v=xQNrFHEMhI4", cue: "Chest on incline bench. Pull elbows back. Squeeze shoulder blades together." },
  dead_hang: { name: "Dead Hang / Band Pull-Up", cat: "pull", muscle: "Back/Grip/Decompression", sets: 3, rep: [20, 30], rest: 90, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/back/dead-hang/", yt: "https://www.youtube.com/watch?v=v5DcDCmBBnI", cue: "Hang first \u2014 build to 60s. Add band for assisted pull-ups. Spinal decompression benefit too." },
  incline_curl: { name: "Incline Bicep Curl", cat: "pull", muscle: "Biceps", sets: 3, rep: [10, 12], rest: 60, weighted: true, solo: false, gif: "https://muscleswiki.com/exercises/biceps/dumbbell-incline-curl/", yt: "https://www.youtube.com/watch?v=soxrZlIl35U", cue: "Arms hang behind body on incline. Full stretch at bottom. No swinging." },
  farmers_carry: { name: "Farmer's Carry (KB/DB)", cat: "pull", muscle: "Core/Grip/Traps", sets: 3, rep: [40, 40], rest: 60, weighted: true, solo: false, unit: "m", gif: "https://muscleswiki.com/exercises/traps/farmers-walk/", yt: "https://www.youtube.com/watch?v=Fkzk_RqlYig", cue: "Tall posture. Shoulders packed down. Breathe steadily. 40m per set." },
  // ── CORE & STABILITY ─────────────────────────────
  plank: { name: "Plank", cat: "core", muscle: "Core", sets: 3, rep: [30, 45], rest: 45, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/core/plank/", yt: "https://www.youtube.com/watch?v=pSHjTRCQxIw", cue: "Neutral spine. Squeeze glutes and quads. Breathe normally." },
  flutter_kicks: { name: "Flutter Kicks", cat: "core", muscle: "Lower Abs", sets: 3, rep: [20, 30], rest: 45, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/core/flutter-kicks/", yt: "https://www.youtube.com/watch?v=ANVdMDaYRts", cue: "Low back pressed to floor. Small rapid kicks. Keep chin tucked." },
  russian_twist: { name: "Russian Twist", cat: "core", muscle: "Obliques", sets: 3, rep: [20, 20], rest: 45, weighted: false, solo: false, unit: "total", gif: "https://muscleswiki.com/exercises/core/russian-twist/", yt: "https://www.youtube.com/watch?v=wkD8rjkodUI", cue: "Feet off floor for challenge. Rotate fully each side. Add medicine ball when ready." },
  bike_crunch: { name: "Bicycle Crunch", cat: "core", muscle: "Obliques/Abs", sets: 3, rep: [20, 20], rest: 45, weighted: false, solo: false, unit: "total", gif: "https://muscleswiki.com/exercises/core/bicycle-crunch/", yt: "https://www.youtube.com/watch?v=9FGilxCbdz8", cue: "Slow and deliberate. Elbow to opposite knee fully. Don't pull your neck." },
  wall_sit: { name: "Wall Sit", cat: "core", muscle: "Quads/Isometric", sets: 3, rep: [30, 60], rest: 45, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/quadriceps/wall-sit/", yt: "https://www.youtube.com/watch?v=y-wV4Venusw", cue: "90\xB0 at knees and hips. Back flat against wall. Build duration gradually." },
  split_squat_bw: { name: "Split Squat (Bodyweight)", cat: "core", muscle: "Quads/Balance", sets: 3, rep: [10, 12], rest: 45, weighted: false, solo: false, unit: "ea", gif: "https://muscleswiki.com/exercises/quadriceps/split-squat/", yt: "https://www.youtube.com/watch?v=U4s4mEQ5VOU", cue: "Great for balance and hip flexor length. Control the descent. Build toward ATG depth." },
  kb_figure8: { name: "Kettlebell Figure 8", cat: "core", muscle: "Core/Hip Mobility", sets: 3, rep: [10, 10], rest: 45, weighted: true, solo: false, unit: "ea dir", gif: "https://muscleswiki.com/exercises/core/kettlebell-figure-8/", yt: "https://www.youtube.com/watch?v=fkTQlLWF-FU", cue: "Wide stance. Keep chest up. Smooth handoff between legs. Hip mobility bonus." },
  horse_stance: { name: "Horse Stance Hold", cat: "core", muscle: "Groin/Core/Balance", sets: 3, rep: [30, 60], rest: 45, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/quadriceps/wall-sit/", yt: "https://x.com/rangeofstrength/status/1865735473919832108", cue: "Wide stance, feet parallel or slightly out. Deep squat position. Back straight. Hip mobility builder." },
  single_leg_bal: { name: "Single-Leg Balance", cat: "core", muscle: "Balance/Ankles", sets: 3, rep: [30, 60], rest: 30, weighted: false, solo: false, unit: "sec/ea", gif: "https://muscleswiki.com/exercises/core/single-leg-stand/", yt: "https://www.youtube.com/watch?v=6IKf_mw7Fjc", cue: "Eyes closed for challenge. Longevity marker \u2014 work up to 10s eyes-closed. Ankle stability." },
  jump_rope: { name: "Jump Rope", cat: "core", muscle: "Cardio/Coordination", sets: 3, rep: [60, 120], rest: 60, weighted: false, solo: false, unit: "sec", gif: "https://muscleswiki.com/exercises/calves/jump-rope/", yt: "https://www.youtube.com/watch?v=FJmRQ5iTXKE", cue: "Light on feet. Land on balls of feet. Soft knees. Start with 30s intervals and build." }
};
const CARDIO_PROTOCOLS = {
  n4x4: {
    name: "Norwegian 4\xD74",
    color: "var(--red)",
    badge: "red",
    desc: `4 intervals at 85\u201395% max HR with 3 min active recovery. Best-researched VO\u2082 max protocol for 50+. 2 years of this reversed 20 years of heart aging in sedentary 50-year-olds.`,
    warmup: "10 min easy elliptical (60% HR)",
    reference: "https://norwegian4x4.com/posts/beginners-guide-norwegian-4x4-workout",
    intervals: [
      { w: `4 min @ ${HR_LOW}\u2013${HR_HIGH} bpm`, r: "3 min easy recovery pace" },
      { w: `4 min @ ${HR_LOW}\u2013${HR_HIGH} bpm`, r: "3 min easy recovery pace" },
      { w: `4 min @ ${HR_LOW}\u2013${HR_HIGH} bpm`, r: "3 min easy recovery pace" },
      { w: `4 min @ ${HR_LOW}\u2013${HR_HIGH} bpm`, r: "5 min cooldown" }
    ]
  },
  bag: {
    name: "Heavy Bag HIIT",
    color: "var(--amber)",
    badge: "amber",
    desc: "5 \xD7 3-min boxing rounds with 1 min rest. Excellent joint-friendly cardio alternative. Engages upper body, core, and coordination simultaneously.",
    warmup: "3 min shadow boxing, easy",
    intervals: [
      { w: "3 min hard combos (jab, cross, hook, body)", r: "1 min rest" },
      { w: "3 min hard combos", r: "1 min rest" },
      { w: "3 min hard combos", r: "1 min rest" },
      { w: "3 min hard combos", r: "1 min rest" },
      { w: "3 min hard combos", r: "Cooldown shadow boxing 2 min" }
    ]
  },
  kb_complex: {
    name: "KB Complex Circuit",
    color: "var(--teal)",
    badge: "teal",
    desc: "Single kettlebell \u2014 back-to-back movements with no rest between exercises, rest between rounds. Builds strength-endurance and keeps HR elevated. Perfect from your bookmarked KB content.",
    warmup: "5 min light swing practice",
    intervals: [
      { w: "8\xD7 Swing \u2192 5\xD7 Clean \u2192 5\xD7 Press \u2192 5\xD7 Goblet Squat (no rest)", r: "90 sec rest" },
      { w: "Repeat circuit", r: "90 sec rest" },
      { w: "Repeat circuit", r: "90 sec rest" },
      { w: "Repeat circuit (final round)", r: "5 min cooldown" }
    ]
  },
  huberman_bike: {
    name: "Huberman Assault Bike",
    color: "var(--purple)",
    badge: "purple",
    desc: "Huberman's Friday protocol: 20\u201330 min with hard 20-sec sprints every 2 min. Can be done on elliptical. Combines Zone 2 base with explosive effort.",
    warmup: "5 min easy warmup",
    reference: "https://x.com/fmfclips/status/1824530543498653771",
    intervals: [
      { w: "2 min moderate pace", r: "20 sec all-out sprint" },
      { w: "2 min moderate pace", r: "20 sec all-out sprint" },
      { w: "2 min moderate pace", r: "20 sec all-out sprint" },
      { w: "2 min moderate pace", r: "20 sec all-out sprint" },
      { w: "2 min moderate pace", r: "20 sec all-out sprint \u2014 then 5 min cooldown" }
    ]
  },
  zone2_walk: {
    name: "Japanese Interval Walk",
    color: "var(--blue)",
    badge: "blue",
    desc: "Alternating 3 min fast walk (vigorous effort) + 3 min slow walk, 5 cycles = 30 min. Research shows 2\xD7 the health benefits of steady walking. Great active recovery day.",
    warmup: "2 min easy walking",
    intervals: [
      { w: "3 min brisk walk (vigorous, slight breathlessness)", r: "3 min easy stroll" },
      { w: "3 min brisk walk", r: "3 min easy stroll" },
      { w: "3 min brisk walk", r: "3 min easy stroll" },
      { w: "3 min brisk walk", r: "3 min easy stroll" },
      { w: "3 min brisk walk", r: "3 min easy cooldown stroll" }
    ]
  }
};
const MOBILITY_PRE = [
  { name: "Joe DeFranco's Limber 11", duration: "11 min", focus: "Full Body / Hip Priority", featured: true, yt: "https://www.youtube.com/watch?v=FSSDLDhbacc", note: "Do before EVERY session. Your go-to pre-workout routine." },
  { name: "5-Min Squat Mobility Routine", duration: "5 min", focus: "Lower Body Pre-Lift", yt: "https://x.com/ThePrehabGuys/status/1856367961092624829", note: "The Prehab Guys. Before any lower body session." },
  { name: "CARs Daily Routine", duration: "5\u20138 min", focus: "All Joints / Maintenance", yt: "https://www.youtube.com/watch?v=LGUhVelktk4", note: "Controlled Articular Rotations. Ideal every morning. Joint health foundation." }
];
const MOBILITY_HIPS = [
  { name: "Lying Crossover Stretch", duration: "60s/side", focus: "Hips / Lower Back", yt: "https://www.youtube.com/watch?v=uJUuApq36Gg", note: "Keep shoulders flat. Let gravity rotate the hip." },
  { name: "Seated Pretzel Stretch", duration: "60s/side", focus: "Hips / Piriformis", yt: "https://www.youtube.com/watch?v=KT6EhNJJxFs", note: "Stack ankle over knee. Sit tall." },
  { name: "Lying Leg Tuck Hip Stretch", duration: "60s/side", focus: "Hip Flexors", yt: "https://www.youtube.com/watch?v=Gs0SyFMiXrc", note: "Pull knee to chest. Extend other leg fully. Counter to sitting all day." },
  { name: "Cobra Pose", duration: "45s", focus: "Hip Flexors / Spine", yt: "https://www.youtube.com/watch?v=JFinFqLYxHQ", note: "Hips stay on floor. Essential desk-worker counterpose." },
  { name: "Windshield Wipers", duration: "10 reps", focus: "Hip Rotation / IT Band", yt: "https://www.youtube.com/watch?v=gRzQvXkzQnk", note: "Knees fall side to side. Hip rotation builder." },
  { name: "Chronically Tight Hips Fix", duration: "5 min", focus: "Hip Flexors / Mobility", yt: "https://x.com/strongerbyD/status/1859978681579622669", note: "Targeted protocol from your bookmarks for desk workers." },
  { name: "6 Exercises If You Sit a Lot", duration: "5 min", focus: "Desk Worker Recovery", yt: "https://x.com/MotionMystique/status/1840731796696445379", note: "Counteracts the damage of prolonged sitting." }
];
const MOBILITY_UPPER = [
  { name: "BJJ Shoulder Stretch", duration: "60s/side", focus: "Shoulder External Rotation", yt: "https://www.youtube.com/watch?v=geQproxP15k", note: "From your bookmarks. Essential for shoulder health with your overhead history." },
  { name: "Reach-Up Side Bend", duration: "45s/side", focus: "Lats / Side Body", yt: "https://www.youtube.com/watch?v=BPCO6WOFP8s", note: "Keep hips stacked. Reach long through fingertips." },
  { name: "Wrist Flexion Stretches", duration: "60s", focus: "Wrists / Forearms", yt: "https://www.youtube.com/watch?v=mSZWSQSSEjE", note: "Essential for KB work and push-up volume. Both flexion and extension." },
  { name: "Neck Exercises (10 reps)", duration: "2 min", focus: "Neck / Traps / Posture", yt: "https://x.com/Upworkout/status/2009635708856877131", note: "From your bookmarks. Desk worker posture correction. Morning and night." },
  { name: "Fix Your Posture Routine", duration: "5 min", focus: "Posture / Upper Back", yt: "https://substack.com/@fixyourposture/note/c-215896888", note: "Your most recent mobility bookmark. Thoracic extension focus." }
];
const MOBILITY_MORNING = [
  { name: "5 Stretches Every Morning", duration: "5 min", focus: "Full Body Wake-Up", yt: "https://www.youtube.com/watch?v=2X7LDuBcPMw", note: "Your bookmarked morning routine. Do before coffee." },
  { name: "CARs Daily Routine", duration: "5 min", focus: "Joint Health / Mobility", yt: "https://www.youtube.com/watch?v=LGUhVelktk4", note: "Controlled Articular Rotations \u2014 shoulder, hip, neck, wrist, ankle." },
  { name: "Angle Toe Touches", duration: "10 reps", focus: "Hamstrings / Hip Hinge", yt: "https://www.youtube.com/watch?v=UGE1kSoSBhk", note: "Feet wide or narrow. Progress your toe touch over time." },
  { name: "Seated Toe Touch", duration: "60s", focus: "Hamstrings / Lower Back", yt: "https://www.youtube.com/watch?v=LtSUxBMBMYE", note: "Reach further each week. Hip tightness is normal \u2014 be patient." }
];
const MOBILITY_BACK = [
  { name: "Lower Back Pain Exercises", duration: "5 min", focus: "Lower Back Health", yt: "https://x.com/NutritionGuide_/status/1817729919482269888", note: "From your bookmarks. Gentle loading for back health." },
  { name: "Back Pain / Tight Joints Routine", duration: "5 min", focus: "Back / Joint Mobility", yt: "https://x.com/GymFiesta/status/2009868409081577693", note: "Bookmarked relief routine." },
  { name: "Calf Wall Stretch", duration: "45s/side", focus: "Ankles / Calves", yt: "https://www.youtube.com/watch?v=qdHR9XsWpj8", note: "Straight then bent-knee version. Both important." },
  { name: "Thoracic Rotation + Extension", duration: "60s/side", focus: "Thoracic Spine", yt: "https://www.youtube.com/watch?v=FSSDLDhbacc", note: "Part of Limber 11. Can be done standalone too." }
];
const MOBILITY_FOOT = [
  { name: "Plantar Fasciitis Prevention", duration: "5 min", focus: "Foot / Arch Health", yt: "https://x.com/Barefoot_Will_/status/1843643091879870677", note: "Bookmarked. Add if you notice any foot discomfort." },
  { name: "Plyometric Tendon Work", duration: "5 min", focus: "Tendon Durability / Feet", yt: "https://x.com/5060fit/status/2009574373187858929", note: "From @5060fit \u2014 two simple plyometric movements for tendon strength." },
  { name: "Foot & Ankle Strength", duration: "5 min", focus: "Foot Strength / Longevity", yt: "https://x.com/movementability/status/1857861441191309421", note: "Starts from your feet \u2014 physiological age connection." }
];
const MAIN_A = ["bench_press", "rdl_db", "goblet_squat", "turkish_getup"];
const MAIN_B = ["clean_deadlift", "bulgarian_split", "kb_swing", "incline_bench_db"];
const PUSH_POOL = ["push_diamond", "push_wide", "push_offset", "incline_fly", "bench_dip", "skull_crusher", "seated_tri", "cuban_press", "seated_ohp", "box_jump"];
const PULL_POOL = ["incline_row", "dead_hang", "incline_curl", "farmers_carry"];
const CORE_POOL = ["plank", "flutter_kicks", "russian_twist", "bike_crunch", "wall_sit", "split_squat_bw", "kb_figure8", "horse_stance", "single_leg_bal", "jump_rope"];
function buildWorkout(type, sessionCount) {
  const pick = (pool, n, offset = 0) => {
    const i = (sessionCount + offset) % pool.length;
    const rotated = [...pool.slice(i), ...pool.slice(0, i)];
    return rotated.slice(0, n);
  };
  const mains = type === "A" ? MAIN_A : MAIN_B;
  const accessories = type === "A" ? [...pick(PUSH_POOL, 2), ...pick(CORE_POOL, 2, 3)] : [...pick(PULL_POOL, 2, 1), ...pick(CORE_POOL, 2, 1)];
  return [...mains, ...accessories].map((id) => __spreadValues({ id }, EX[id]));
}
async function sget(k) {
  try {
    const v = localStorage.getItem(k);
    return v ? JSON.parse(v) : null;
  } catch (e) {
    return null;
  }
}
async function sset(k, v) {
  try {
    localStorage.setItem(k, JSON.stringify(v));
  } catch (e) {
  }
}
const DW = { bench_press: 50, rdl_db: 30, goblet_squat: 30, turkish_getup: 16, clean_deadlift: 95, bulgarian_split: 20, kb_swing: 16, incline_bench_db: 25, incline_fly: 15, skull_crusher: 15, seated_tri: 20, cuban_press: 8, seated_ohp: 20, incline_row: 25, farmers_carry: 30, incline_curl: 15, kb_figure8: 12, horse_stance: 0, box_jump: 0 };
function analyzeProgression(history, exId, exercise) {
  var _a, _b;
  const sessions = history.filter((s) => {
    var _a2;
    return s.type === "strength" && ((_a2 = s.sets) == null ? void 0 : _a2[exId]);
  }).slice(0, 4);
  if (sessions.length < 2) return null;
  const last2 = sessions.slice(0, 2).map((s) => s.sets[exId]);
  const maxReps = exercise.rep[1];
  if (last2.filter((s) => s.some((x) => x.status === "fail")).length >= 2) {
    const lw = ((_a = last2[0].find((s) => s.weight > 0)) == null ? void 0 : _a.weight) || 0;
    return { type: "deweight", suggestedWeight: Math.round(lw * 0.9 / 2.5) * 2.5, reason: "2 consecutive sessions with failed sets" };
  }
  const ready = last2.every(
    (sess) => sess.filter((s) => s.status === "done").length === exercise.sets && sess.filter((s) => s.status === "done").every((s) => +s.reps >= maxReps)
  );
  if (ready) {
    const lw = ((_b = last2[0].find((s) => s.weight > 0)) == null ? void 0 : _b.weight) || DW[exId] || 0;
    return { type: "increase", suggestedWeight: lw + (lw >= 80 ? 5 : 2.5), reason: `Hit all ${maxReps} reps for 2 sessions in a row` };
  }
  return null;
}
function needsDeload(history) {
  const s = history.filter((h) => h.type === "strength");
  if (s.length < 12) return false;
  if (s.filter((h) => !h.isDeload).length >= 12) return true;
  const r4 = s.slice(0, 4);
  return r4.length >= 4 && r4.filter((x) => x.sets && Object.values(x.sets).flat().some((y) => y.status === "fail")).length >= 3;
}
const Ic = {
  home: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" }), /* @__PURE__ */ React.createElement("polyline", { points: "9,22 9,12 15,12 15,22" })),
  lift: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M6.5 6.5h11M6.5 17.5h11M4 9.5v5M8 7v10M16 7v10M20 9.5v5" })),
  heart: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z" })),
  fire: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M12 2c0 6-6 8-6 14a6 6 0 0012 0c0-6-6-8-6-14z" })),
  bot: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("rect", { x: "3", y: "11", width: "18", height: "11", rx: "2" }), /* @__PURE__ */ React.createElement("path", { d: "M12 11V5" }), /* @__PURE__ */ React.createElement("circle", { cx: "12", cy: "4", r: "1" }), /* @__PURE__ */ React.createElement("line", { x1: "8", y1: "15", x2: "8", y2: "15", strokeWidth: "2.5", strokeLinecap: "round" }), /* @__PURE__ */ React.createElement("line", { x1: "16", y1: "15", x2: "16", y2: "15", strokeWidth: "2.5", strokeLinecap: "round" })),
  leaf: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M17 8C8 10 5.9 16.17 3.82 19.34a1 1 0 001.64 1.16C7 19 8.5 18 12 18c4 0 7-3 7-7 0-1-.5-2-1-2.5" }), /* @__PURE__ */ React.createElement("path", { d: "M3 21c0-7 4-12 9-12" })),
  chev: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, /* @__PURE__ */ React.createElement("polyline", { points: "9,18 15,12 9,6" })),
  play: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("circle", { cx: "12", cy: "12", r: "10" }), /* @__PURE__ */ React.createElement("polygon", { points: "10,8 16,12 10,16", fill: "currentColor", stroke: "none" })),
  link: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" }), /* @__PURE__ */ React.createElement("path", { d: "M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" })),
  x: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2.5" }, /* @__PURE__ */ React.createElement("line", { x1: "18", y1: "6", x2: "6", y2: "18" }), /* @__PURE__ */ React.createElement("line", { x1: "6", y1: "6", x2: "18", y2: "18" })),
  warn: /* @__PURE__ */ React.createElement("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor" }, /* @__PURE__ */ React.createElement("path", { d: "M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" }), /* @__PURE__ */ React.createElement("line", { x1: "12", y1: "9", x2: "12", y2: "13" }), /* @__PURE__ */ React.createElement("line", { x1: "12", y1: "17", x2: "12.01", y2: "17" }))
};
function Ring({ value, max, size = 88, stroke = 7, color = "var(--lime)", children }) {
  const r = (size - stroke) / 2, circ = 2 * Math.PI * r, dash = Math.min(value / max, 1) * circ;
  return /* @__PURE__ */ React.createElement("div", { style: { position: "relative", width: size, height: size, flexShrink: 0 } }, /* @__PURE__ */ React.createElement("svg", { width: size, height: size, className: "pring" }, /* @__PURE__ */ React.createElement("circle", { cx: size / 2, cy: size / 2, r, fill: "none", stroke: "var(--s4)", strokeWidth: stroke }), /* @__PURE__ */ React.createElement(
    "circle",
    {
      cx: size / 2,
      cy: size / 2,
      r,
      fill: "none",
      stroke: color,
      strokeWidth: stroke,
      strokeLinecap: "round",
      strokeDasharray: `${dash} ${circ}`,
      style: { transition: "stroke-dasharray .5s ease" }
    }
  )), /* @__PURE__ */ React.createElement("div", { style: { position: "absolute", inset: 0, display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column" } }, children));
}
function RestTimer({ seconds, onDone, nextEx }) {
  const [rem, setRem] = useState(seconds);
  const ref = useRef();
  useEffect(() => {
    ref.current = setInterval(() => setRem((r) => {
      if (r <= 1) {
        clearInterval(ref.current);
        onDone();
        return 0;
      }
      return r - 1;
    }), 1e3);
    return () => clearInterval(ref.current);
  }, []);
  useEffect(() => {
    if (rem <= 3 && rem > 0 && navigator.vibrate) navigator.vibrate(100);
  }, [rem]);
  const r2 = 104, circ = 2 * Math.PI * r2, pct = rem / seconds;
  return /* @__PURE__ */ React.createElement("div", { className: "ov fade" }, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", letterSpacing: "1.5px", textTransform: "uppercase" } }, "Rest Period"), /* @__PURE__ */ React.createElement("div", { style: { position: "relative", width: 236, height: 236, margin: "8px 0" } }, /* @__PURE__ */ React.createElement("svg", { width: 236, height: 236, className: "pring" }, /* @__PURE__ */ React.createElement("circle", { cx: 118, cy: 118, r: r2, fill: "none", stroke: "var(--s4)", strokeWidth: 9 }), /* @__PURE__ */ React.createElement(
    "circle",
    {
      cx: 118,
      cy: 118,
      r: r2,
      fill: "none",
      stroke: "var(--lime)",
      strokeWidth: 9,
      strokeLinecap: "round",
      strokeDasharray: `${pct * circ} ${circ}`,
      style: { transition: "stroke-dasharray 1s linear" }
    }
  )), /* @__PURE__ */ React.createElement("div", { style: { position: "absolute", inset: 0, display: "flex", alignItems: "center", justifyContent: "center" } }, /* @__PURE__ */ React.createElement("div", { className: "rt" }, String(Math.floor(rem / 60)).padStart(2, "0"), ":", String(rem % 60).padStart(2, "0")))), nextEx && /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t3)" } }, "Next: ", /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--text)" } }, nextEx)), /* @__PURE__ */ React.createElement("button", { className: "btn ghost", style: { marginTop: 20 }, onClick: onDone }, "Skip Rest"));
}
function DemoModal({ ex, onClose }) {
  return /* @__PURE__ */ React.createElement("div", { className: "dm fade" }, /* @__PURE__ */ React.createElement("div", { className: "dm-head" }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "dm-title" }, ex.name), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t2)", marginTop: 2 } }, ex.muscle)), /* @__PURE__ */ React.createElement("button", { className: "btn ghost sm", onClick: onClose, style: { padding: "8px 10px" } }, Ic.x)), /* @__PURE__ */ React.createElement("div", { style: { padding: "16px 18px" } }, /* @__PURE__ */ React.createElement("div", { className: "co lime", style: { margin: "0 0 12px" } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--lime)" } }, "\u{1F4CB} Coaching Cue"), /* @__PURE__ */ React.createElement("br", null), ex.cue), ex.safetyNote && /* @__PURE__ */ React.createElement("div", { className: "co amber", style: { margin: "0 0 12px", display: "flex", gap: 10 } }, /* @__PURE__ */ React.createElement("span", { style: { color: "var(--amber)", flexShrink: 0 } }, Ic.warn), /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--amber)" } }, "Solo Training Note"), /* @__PURE__ */ React.createElement("br", null), ex.safetyNote)), /* @__PURE__ */ React.createElement("div", { className: "card", style: { margin: "0 0 12px" } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Prescription"), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 8, flexWrap: "wrap" } }, /* @__PURE__ */ React.createElement("span", { className: "badge lime" }, ex.sets, " sets"), /* @__PURE__ */ React.createElement("span", { className: "badge blue" }, ex.rep[0], "\u2013", ex.rep[1], " ", ex.unit || "reps"), /* @__PURE__ */ React.createElement("span", { className: "badge amber" }, ex.rest, "s rest"), ex.cat === "main" && /* @__PURE__ */ React.createElement("span", { className: "badge teal" }, "Main Lift"))), /* @__PURE__ */ React.createElement("a", { href: ex.yt, target: "_blank", rel: "noopener noreferrer", className: "btn full blue", style: { marginBottom: 10, textDecoration: "none" } }, Ic.play, "\xA0Watch on YouTube"), /* @__PURE__ */ React.createElement("a", { href: ex.gif, target: "_blank", rel: "noopener noreferrer", className: "btn full ghost", style: { textDecoration: "none" } }, Ic.link, "\xA0Open on MusclesWiki")));
}
function ProgModal({ suggestions, onConfirm, onDismiss }) {
  return /* @__PURE__ */ React.createElement("div", { className: "prog-modal fade" }, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 36 } }, "\u{1F3AF}"), /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 34, color: "var(--lime)" } }, "PROGRESSION READY"), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 13, color: "var(--t2)", textAlign: "center", marginBottom: 8 } }, "Based on your last 2 sessions:"), /* @__PURE__ */ React.createElement("div", { style: { width: "100%", maxWidth: 340, display: "flex", flexDirection: "column", gap: 8, marginBottom: 8 } }, suggestions.map((s, i) => /* @__PURE__ */ React.createElement("div", { key: i, style: { background: "var(--s2)", border: "1px solid var(--border)", borderRadius: "var(--r)", padding: "12px 14px" } }, /* @__PURE__ */ React.createElement("div", { style: { fontWeight: 600, marginBottom: 6 } }, s.name), /* @__PURE__ */ React.createElement("span", { className: `badge ${s.rec.type === "increase" ? "lime" : "red"}` }, s.rec.type === "increase" ? `\u2191 ${s.rec.suggestedWeight} lb` : `\u2193 ${s.rec.suggestedWeight} lb`), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 5 } }, s.rec.reason)))), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 10 } }, /* @__PURE__ */ React.createElement("button", { className: "btn", onClick: onConfirm }, "Apply Changes"), /* @__PURE__ */ React.createElement("button", { className: "btn ghost", onClick: onDismiss }, "Not Now")));
}
function ExCard({ ex, setData, onSetChange, activeEx, setActiveEx, setDemoEx, weights, isDeload }) {
  var _a, _b;
  const sets = setData[ex.id] || [];
  const doneSets = sets.filter((s) => s.status === "done").length;
  const hasFail = sets.some((s) => s.status === "fail");
  const isOpen = activeEx === ex.id;
  const lastW = (_b = (_a = weights[ex.id]) != null ? _a : DW[ex.id]) != null ? _b : 0;
  const dispW = isDeload ? Math.round(lastW * 0.6 / 2.5) * 2.5 : lastW;
  return /* @__PURE__ */ React.createElement("div", { style: { borderBottom: "1px solid var(--border)", paddingBottom: isOpen ? 14 : 0 } }, /* @__PURE__ */ React.createElement(
    "div",
    {
      style: { display: "flex", alignItems: "center", justifyContent: "space-between", padding: "12px 0", cursor: "pointer" },
      onClick: () => setActiveEx(isOpen ? null : ex.id)
    },
    /* @__PURE__ */ React.createElement("div", { style: { flex: 1, minWidth: 0, paddingRight: 8 } }, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", alignItems: "center", gap: 6 } }, /* @__PURE__ */ React.createElement("span", { className: "en" }, ex.name), ex.safetyNote && /* @__PURE__ */ React.createElement("span", { style: { color: "var(--amber)", display: "flex", flexShrink: 0, width: 14, height: 14 } }, Ic.warn)), /* @__PURE__ */ React.createElement("div", { className: "ed" }, ex.muscle, " \xB7 ", ex.sets, "\xD7", ex.rep[0], "\u2013", ex.rep[1], " ", ex.unit || "reps", " \xB7 ", ex.rest, "s rest"), ex.weighted && dispW > 0 && /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, "Last: ", /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--t2)" } }, dispW, " lb"), isDeload && /* @__PURE__ */ React.createElement("span", { style: { color: "var(--amber)" } }, " (60% deload)"))),
    /* @__PURE__ */ React.createElement("div", { style: { display: "flex", alignItems: "center", gap: 5, flexShrink: 0 } }, /* @__PURE__ */ React.createElement("button", { className: "btn xs ghost", onClick: (e) => {
      e.stopPropagation();
      setDemoEx(ex);
    } }, Ic.play), hasFail && /* @__PURE__ */ React.createElement("span", { className: "badge red" }, "FAIL"), doneSets > 0 && /* @__PURE__ */ React.createElement("span", { className: "badge lime" }, doneSets, "/", ex.sets), /* @__PURE__ */ React.createElement("span", { style: { color: "var(--t3)", transform: isOpen ? "rotate(90deg)" : "", transition: "transform .2s", display: "flex" } }, Ic.chev))
  ), isOpen && /* @__PURE__ */ React.createElement("div", { className: "fade" }, ex.safetyNote && /* @__PURE__ */ React.createElement("div", { style: { background: "var(--ad)", border: "1px solid rgba(245,168,63,.2)", borderRadius: 8, padding: "8px 12px", marginBottom: 10, fontSize: 12, color: "var(--t2)", display: "flex", gap: 8 } }, /* @__PURE__ */ React.createElement("span", { style: { color: "var(--amber)", flexShrink: 0 } }, "\u26A0\uFE0F"), ex.safetyNote), /* @__PURE__ */ React.createElement("div", { className: "sh" }, /* @__PURE__ */ React.createElement("span", null, "#"), /* @__PURE__ */ React.createElement("span", null, ex.weighted ? "Weight" : "\u2014"), /* @__PURE__ */ React.createElement("span", null, ex.unit || "Reps"), /* @__PURE__ */ React.createElement("span", { style: { textAlign: "center" } }, "\u2713/\u2715")), sets.map((s, si) => {
    const isFail = s.status === "fail", isDone = s.status === "done";
    return /* @__PURE__ */ React.createElement("div", { key: si, className: "sr" }, /* @__PURE__ */ React.createElement("div", { className: "sn" }, si + 1), ex.weighted ? /* @__PURE__ */ React.createElement("input", { className: `si ${isFail ? "fail" : ""}`, type: "number", inputMode: "decimal", placeholder: String(dispW || ""), value: s.weight, onChange: (e) => onSetChange(ex.id, si, __spreadProps(__spreadValues({}, s), { weight: e.target.value })) }) : /* @__PURE__ */ React.createElement("div", { className: "si", style: { color: "var(--t3)", fontSize: 11, display: "flex", alignItems: "center", justifyContent: "center" } }, "BW"), /* @__PURE__ */ React.createElement("input", { className: `si ${isFail ? "fail" : ""}`, type: "number", inputMode: "decimal", placeholder: String(ex.rep[0]), value: s.reps, onChange: (e) => onSetChange(ex.id, si, __spreadProps(__spreadValues({}, s), { reps: e.target.value })) }), /* @__PURE__ */ React.createElement("div", { className: "sbs" }, /* @__PURE__ */ React.createElement(
      "button",
      {
        className: "sb",
        style: { background: isDone ? "var(--lime)" : "var(--s4)", borderColor: isDone ? "var(--lime)" : "var(--border)" },
        onClick: () => onSetChange(ex.id, si, __spreadProps(__spreadValues({}, s), { status: isDone ? null : "done" }))
      },
      isDone && /* @__PURE__ */ React.createElement("svg", { width: "12", height: "12", viewBox: "0 0 24 24", fill: "none", stroke: "#000", strokeWidth: "3" }, /* @__PURE__ */ React.createElement("polyline", { points: "20,6 9,17 4,12" }))
    ), /* @__PURE__ */ React.createElement(
      "button",
      {
        className: "sb",
        style: { background: isFail ? "var(--red)" : "var(--s4)", borderColor: isFail ? "var(--red)" : "var(--border)" },
        onClick: () => onSetChange(ex.id, si, __spreadProps(__spreadValues({}, s), { status: isFail ? null : "fail" }))
      },
      /* @__PURE__ */ React.createElement("svg", { width: "10", height: "10", viewBox: "0 0 24 24", fill: "none", stroke: isFail ? "#fff" : "var(--t3)", strokeWidth: "2.5" }, /* @__PURE__ */ React.createElement("line", { x1: "18", y1: "6", x2: "6", y2: "18" }), /* @__PURE__ */ React.createElement("line", { x1: "6", y1: "6", x2: "18", y2: "18" }))
    )));
  })));
}
function StrengthTab({ history, setHistory, weights, setWeights }) {
  const [wType, setWType] = useState("A");
  const [view, setView] = useState("log");
  const [setData, setSetData] = useState({});
  const [restTimer, setRestTimer] = useState(null);
  const [activeEx, setActiveEx] = useState(null);
  const [demoEx, setDemoEx] = useState(null);
  const [progSugg, setProgSugg] = useState(null);
  const sessionCount = history.filter((h) => h.type === "strength").length;
  const isDeload = needsDeload(history);
  const exercises = buildWorkout(wType, sessionCount);
  useEffect(() => {
    const init = {};
    exercises.forEach((ex) => {
      init[ex.id] = Array.from({ length: ex.sets }, () => ({ weight: "", reps: "", status: null }));
    });
    setSetData(init);
    setActiveEx(null);
  }, [wType, sessionCount]);
  useEffect(() => {
    const suggs = [];
    exercises.forEach((ex) => {
      if (!ex.weighted) return;
      const rec = analyzeProgression(history, ex.id, ex);
      if (rec) suggs.push({ id: ex.id, name: ex.name, rec });
    });
    setProgSugg(suggs.length > 0 ? suggs : null);
  }, [wType, history.length]);
  const handleSet = (exId, si, newD) => {
    var _a, _b, _c;
    setSetData((prev) => __spreadProps(__spreadValues({}, prev), { [exId]: prev[exId].map((s, i) => i === si ? newD : s) }));
    if ((newD.status === "done" || newD.status === "fail") && !((_b = (_a = setData[exId]) == null ? void 0 : _a[si]) == null ? void 0 : _b.status)) {
      const ex = exercises.find((e) => e.id === exId);
      const idx = exercises.findIndex((e) => e.id === exId);
      if ((ex == null ? void 0 : ex.rest) > 0) setRestTimer({ seconds: ex.rest, nextEx: (_c = exercises[idx + 1]) == null ? void 0 : _c.name });
    }
  };
  const complete = async () => {
    if (!Object.values(setData).flat().some((s) => s.status)) {
      alert("Log at least one set first.");
      return;
    }
    const session = { id: Date.now(), date: (/* @__PURE__ */ new Date()).toDateString(), type: "strength", workout: wType, name: `Workout ${wType}`, isDeload, sets: setData, exercises: exercises.map((e) => e.id) };
    const nh = [session, ...history];
    setHistory(nh);
    await sset("history", nh);
    const nw = __spreadValues({}, weights);
    exercises.forEach((ex) => {
      const best = Math.max(...(setData[ex.id] || []).filter((s) => s.weight > 0).map((s) => +s.weight), 0);
      if (best > 0) nw[ex.id] = best;
    });
    setWeights(nw);
    await sset("weights", nw);
    setView("history");
    alert(`\u2705 Workout ${wType} complete!`);
  };
  const applyProg = async () => {
    const nw = __spreadValues({}, weights);
    progSugg.forEach((s) => {
      nw[s.id] = s.rec.suggestedWeight;
    });
    setWeights(nw);
    await sset("weights", nw);
    setProgSugg(null);
  };
  const done = Object.values(setData).flat().filter((s) => s.status).length;
  const total = exercises.reduce((a, e) => a + e.sets, 0);
  const fails = Object.values(setData).flat().filter((s) => s.status === "fail").length;
  const mainExes = exercises.filter((e) => e.cat === "main");
  const accExes = exercises.filter((e) => e.cat !== "main");
  return /* @__PURE__ */ React.createElement("div", null, restTimer && /* @__PURE__ */ React.createElement(RestTimer, { seconds: restTimer.seconds, nextEx: restTimer.nextEx, onDone: () => setRestTimer(null) }), progSugg && /* @__PURE__ */ React.createElement(ProgModal, { suggestions: progSugg, onConfirm: applyProg, onDismiss: () => setProgSugg(null) }), demoEx && /* @__PURE__ */ React.createElement(DemoModal, { ex: demoEx, onClose: () => setDemoEx(null) }), /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", alignItems: "flex-start", justifyContent: "space-between" } }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "LIFT"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, isDeload ? "\u{1F504} Deload Week" : "Full Body A/B \xB7 Session " + (sessionCount + 1))), /* @__PURE__ */ React.createElement(Ring, { value: done, max: total, size: 58, stroke: 5 }, /* @__PURE__ */ React.createElement("span", { style: { fontSize: 10, fontFamily: "var(--fm)", color: "var(--lime)" } }, done, "/", total)))), isDeload && /* @__PURE__ */ React.createElement("div", { className: "dlb" }, /* @__PURE__ */ React.createElement("span", { style: { fontSize: 20 } }, "\u26A0\uFE0F"), /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { style: { fontWeight: 700, color: "var(--amber)", marginBottom: 3 } }, "Deload Week"), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t2)" } }, "All weights at 60%. Same volume. Focus on form and recovery."))), /* @__PURE__ */ React.createElement("div", { className: "tabs" }, /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "log" ? "on" : ""}`, onClick: () => setView("log") }, "Log Workout"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "history" ? "on" : ""}`, onClick: () => setView("history") }, "History"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "warmup" ? "on" : ""}`, onClick: () => setView("warmup") }, "Warm-up"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "library" ? "on" : ""}`, onClick: () => setView("library") }, "Library")), view === "log" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 8, padding: "10px 16px 0", flexWrap: "wrap" } }, ["A", "B"].map((w) => /* @__PURE__ */ React.createElement("button", { key: w, className: `btn sm ${wType === w ? "" : "ghost"}`, onClick: () => setWType(w) }, "Workout ", w))), /* @__PURE__ */ React.createElement("div", { className: "co teal", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--teal)" } }, "\u{1F504} Session ", sessionCount + 1, " \u2014 Accessories Rotated"), /* @__PURE__ */ React.createElement("br", null), "Main lifts stay consistent. Accessories auto-rotate every session from your full exercise pool."), fails > 0 && /* @__PURE__ */ React.createElement("div", { className: "co red", style: { marginTop: 8 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--red)" } }, "\u26A1 ", fails, " Failed Set", fails > 1 ? "s" : ""), " \u2014 2 consecutive sessions with fails triggers a deweight suggestion."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Main Lifts ", /* @__PURE__ */ React.createElement("span", { className: "badge teal", style: { fontSize: 9, marginLeft: 4 } }, "Consistent")), mainExes.map((ex) => /* @__PURE__ */ React.createElement(ExCard, { key: ex.id, ex, setData, onSetChange: handleSet, activeEx, setActiveEx, setDemoEx, weights, isDeload }))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Accessories ", /* @__PURE__ */ React.createElement("span", { className: "badge purple", style: { fontSize: 9, marginLeft: 4 } }, "Rotates Each Session")), accExes.map((ex) => /* @__PURE__ */ React.createElement(ExCard, { key: ex.id, ex, setData, onSetChange: handleSet, activeEx, setActiveEx, setDemoEx, weights, isDeload }))), /* @__PURE__ */ React.createElement("div", { style: { padding: "14px 16px" } }, /* @__PURE__ */ React.createElement("button", { className: "btn full", onClick: complete }, "\u2713 Complete Workout ", wType))), view === "history" && /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Recent Sessions"), history.filter((h) => h.type === "strength").length === 0 && /* @__PURE__ */ React.createElement("div", { style: { color: "var(--t3)", fontSize: 13, padding: "4px 0" } }, "No sessions yet. Start your first workout!"), history.filter((h) => h.type === "strength").slice(0, 14).map((s) => {
    const f = s.sets ? Object.values(s.sets).flat().filter((x) => x.status === "fail").length : 0;
    const d = s.sets ? Object.values(s.sets).flat().filter((x) => x.status === "done").length : 0;
    return /* @__PURE__ */ React.createElement("div", { key: s.id, className: "er" }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "en" }, s.name, s.isDeload ? " \u{1F504}" : ""), /* @__PURE__ */ React.createElement("div", { className: "ed" }, s.date), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 5, marginTop: 4, flexWrap: "wrap" } }, d > 0 && /* @__PURE__ */ React.createElement("span", { className: "badge lime" }, d, " done"), f > 0 && /* @__PURE__ */ React.createElement("span", { className: "badge red" }, f, " failed"))));
  })), view === "warmup" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co teal", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--teal)" } }, "\u{1F9B5} Hip Priority \u2014 You Sit All Day"), /* @__PURE__ */ React.createElement("br", null), "Start every session with Limber 11. Then add targeted hip stretches. CARs daily, even on rest days."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Featured Pre-Workout Routines"), MOBILITY_PRE.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en", style: { color: m.featured ? "var(--lime)" : "var(--text)" } }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, m.note)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: "btn sm teal", style: { textDecoration: "none", marginLeft: 10 } }, "\u25B6")))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Hip & Desk-Worker Mobility"), MOBILITY_HIPS.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, m.note)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: "btn xs ghost", style: { textDecoration: "none", marginLeft: 8 } }, "\u25B6")))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Upper Body & Shoulder"), MOBILITY_UPPER.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, m.note)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: "btn xs ghost", style: { textDecoration: "none", marginLeft: 8 } }, "\u25B6")))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Lower Back & Spine"), MOBILITY_BACK.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, m.note)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: "btn xs ghost", style: { textDecoration: "none", marginLeft: 8 } }, "\u25B6")))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Foot Care & Tendon Health"), MOBILITY_FOOT.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: "btn xs ghost", style: { textDecoration: "none", marginLeft: 8 } }, "\u25B6"))))), view === "library" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co lime", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--lime)" } }, "\u{1F4DA} Full Exercise Library"), /* @__PURE__ */ React.createElement("br", null), "All exercises from your program + Raindrop bookmarks. Tap \u25B6 for demo, cue, and YouTube link."), Object.entries(
    Object.values(EX).reduce((acc, ex) => {
      const c = ex.cat === "main" ? "Main Lifts" : ex.cat === "push" ? "Push / Power" : ex.cat === "pull" ? "Pull" : "Core & Stability";
      if (!acc[c]) acc[c] = [];
      acc[c].push(ex);
      return acc;
    }, {})
  ).map(([cat, exes]) => /* @__PURE__ */ React.createElement("div", { className: "card", key: cat, style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, cat), exes.map((ex) => /* @__PURE__ */ React.createElement("div", { key: ex.id, className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, ex.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, ex.muscle)), /* @__PURE__ */ React.createElement("button", { className: "btn xs ghost", onClick: () => setDemoEx(ex) }, "\u25B6 Demo")))))), /* @__PURE__ */ React.createElement("div", { className: "gap" }));
}
function CardioTab({ history, setHistory }) {
  const [proto, setProto] = useState("n4x4");
  const [secs, setSecs] = useState(0);
  const [running, setRunning] = useState(false);
  const [done, setDone] = useState(0);
  const timerRef = useRef();
  useEffect(() => {
    if (running) timerRef.current = setInterval(() => setSecs((s) => s + 1), 1e3);
    else clearInterval(timerRef.current);
    return () => clearInterval(timerRef.current);
  }, [running]);
  const fmt = (s) => `${String(Math.floor(s / 60)).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}`;
  const save = async () => {
    const p2 = CARDIO_PROTOCOLS[proto];
    const log = { id: Date.now(), date: (/* @__PURE__ */ new Date()).toDateString(), type: "cardio", name: p2.name, duration: fmt(secs) };
    const nh = [log, ...history];
    setHistory(nh);
    await sset("history", nh);
    setRunning(false);
    setSecs(0);
    setDone(0);
    alert(`\u2705 ${p2.name} saved!`);
  };
  const p = CARDIO_PROTOCOLS[proto];
  return /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "flex-start" } }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "CARDIO"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, "VO\u2082 Max \xB7 5 Protocols")), /* @__PURE__ */ React.createElement("div", { style: { textAlign: "right" } }, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 9, color: "var(--t3)", letterSpacing: ".8px" } }, "HR ZONE"), /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 26, color: "var(--red)", lineHeight: 1 } }, HR_LOW, "\u2013", HR_HIGH), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 9, color: "var(--t3)" } }, "BPM (max ", MAX_HR, ")")))), /* @__PURE__ */ React.createElement("div", { className: "tabs" }, Object.entries(CARDIO_PROTOCOLS).map(([key, cp]) => /* @__PURE__ */ React.createElement("div", { key, className: `tab ${proto === key ? "on" : ""}`, onClick: () => {
    setProto(key);
    setDone(0);
  } }, cp.name))), /* @__PURE__ */ React.createElement("div", { className: `co ${p.badge}`, style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: p.color } }, p.name), /* @__PURE__ */ React.createElement("br", null), p.desc, p.reference && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("br", null), /* @__PURE__ */ React.createElement("a", { href: p.reference, target: "_blank", rel: "noopener noreferrer", style: { color: p.color, fontSize: 12 } }, "\u2192 Reference guide"))), /* @__PURE__ */ React.createElement("div", { className: "card", style: { textAlign: "center" } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Session Timer"), /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 76, letterSpacing: 2, color: running ? p.color : "var(--text)", transition: "color .3s" } }, fmt(secs)), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 8, justifyContent: "center", marginTop: 12, flexWrap: "wrap" } }, /* @__PURE__ */ React.createElement("button", { className: `btn ${running ? p.badge : ""}`, onClick: () => setRunning((r) => !r) }, running ? "\u23F8 Pause" : "\u25B6 Start"), /* @__PURE__ */ React.createElement("button", { className: "btn ghost sm", onClick: () => {
    setRunning(false);
    setSecs(0);
  } }, "Reset"), secs > 30 && /* @__PURE__ */ React.createElement("button", { className: "btn sm", onClick: save }, "\u2713 Save"))), /* @__PURE__ */ React.createElement("div", { className: "card" }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Intervals \u2014 tap to check off"), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t3)", marginBottom: 10 } }, "Warmup: ", p.warmup), p.intervals.map((iv, i) => /* @__PURE__ */ React.createElement(
    "div",
    {
      key: i,
      style: { display: "flex", gap: 12, padding: "10px 0", borderBottom: "1px solid var(--border)", cursor: "pointer", alignItems: "flex-start" },
      onClick: () => setDone((d) => i < d ? i : i + 1)
    },
    /* @__PURE__ */ React.createElement("div", { style: { width: 24, height: 24, borderRadius: 6, flexShrink: 0, background: done > i ? "var(--lime)" : "var(--s4)", border: `1.5px solid ${done > i ? "var(--lime)" : "var(--b2)"}`, display: "flex", alignItems: "center", justifyContent: "center", transition: "all .2s" } }, done > i && /* @__PURE__ */ React.createElement("svg", { width: "12", height: "12", viewBox: "0 0 24 24", fill: "none", stroke: "#000", strokeWidth: "3" }, /* @__PURE__ */ React.createElement("polyline", { points: "20,6 9,17 4,12" }))),
    /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { style: { fontWeight: 600, fontSize: 14 } }, "Interval ", i + 1, ": ", iv.w), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t2)", marginTop: 2 } }, iv.r))
  ))), /* @__PURE__ */ React.createElement("div", { className: "card" }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Recent Sessions"), history.filter((h) => h.type === "cardio").length === 0 && /* @__PURE__ */ React.createElement("div", { style: { color: "var(--t3)", fontSize: 13 } }, "No sessions yet."), history.filter((h) => h.type === "cardio").slice(0, 6).map((s) => {
    var _a;
    return /* @__PURE__ */ React.createElement("div", { key: s.id, className: "er" }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "en" }, s.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, s.date)), /* @__PURE__ */ React.createElement("span", { className: `badge ${((_a = CARDIO_PROTOCOLS[Object.keys(CARDIO_PROTOCOLS).find((k) => CARDIO_PROTOCOLS[k].name === s.name)]) == null ? void 0 : _a.badge) || "blue"}` }, s.duration));
  })), /* @__PURE__ */ React.createElement("div", { className: "gap" }));
}
function MobilityTab() {
  const [view, setView] = useState("morning");
  const MobRow = ({ m }) => /* @__PURE__ */ React.createElement("div", { className: "er" }, /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "en" }, m.name), /* @__PURE__ */ React.createElement("div", { className: "ed" }, m.focus, " \xB7 ", m.duration), m.note && /* @__PURE__ */ React.createElement("div", { style: { fontSize: 11, color: "var(--t3)", marginTop: 2 } }, m.note)), /* @__PURE__ */ React.createElement("a", { href: m.yt, target: "_blank", rel: "noopener noreferrer", className: `btn xs ${m.featured ? "teal" : "ghost"}`, style: { textDecoration: "none", marginLeft: 8, flexShrink: 0 } }, "\u25B6"));
  return /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "MOBILITY"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, "Hip priority \xB7 desk worker focus")), /* @__PURE__ */ React.createElement("div", { className: "tabs" }, /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "morning" ? "on" : ""}`, onClick: () => setView("morning") }, "Morning"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "preworkout" ? "on" : ""}`, onClick: () => setView("preworkout") }, "Pre-Workout"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "hips" ? "on" : ""}`, onClick: () => setView("hips") }, "Hips"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "upper" ? "on" : ""}`, onClick: () => setView("upper") }, "Upper"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "back" ? "on" : ""}`, onClick: () => setView("back") }, "Back"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "feet" ? "on" : ""}`, onClick: () => setView("feet") }, "Feet")), view === "morning" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co pink", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--pink)" } }, "\u2600\uFE0F Morning Routine \u2014 Do Before Coffee"), /* @__PURE__ */ React.createElement("br", null), "You sit all day. This 10-min morning flow counteracts that daily. Even on rest days. Especially on rest days."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Daily Morning Flow"), MOBILITY_MORNING.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), view === "preworkout" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co teal", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--teal)" } }, "Pre-Workout \u2014 Every Session"), /* @__PURE__ */ React.createElement("br", null), "Limber 11 first, always. Then add from this list based on what you're training."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Pre-Workout Routines"), MOBILITY_PRE.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), view === "hips" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co amber", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--amber)" } }, "\u{1F9B5} Hip Mobility Priority"), /* @__PURE__ */ React.createElement("br", null), "You've identified tight hips as your #1 limitation. These are directly pulled from your Raindrop bookmarks."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Hip & Desk-Worker Stretches"), MOBILITY_HIPS.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), view === "upper" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co blue", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--blue)" } }, "Shoulder & Upper Body"), /* @__PURE__ */ React.createElement("br", null), "The BJJ shoulder stretch is especially important given your shoulder history. Do it daily."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Upper Body Mobility"), MOBILITY_UPPER.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), view === "back" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co purple", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--purple)" } }, "Lower Back & Spine"), /* @__PURE__ */ React.createElement("br", null), "Back issues are in your bookmarks. Weak core, tight hamstrings, and weak glutes are the usual culprits."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Back Health"), MOBILITY_BACK.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), view === "feet" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co lime", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--lime)" } }, "Foot Care & Tendon Health"), /* @__PURE__ */ React.createElement("br", null), "You have a whole foot care section bookmarked. Foot health = longevity. Starts from the ground up."), /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Foot & Ankle"), MOBILITY_FOOT.map((m, i) => /* @__PURE__ */ React.createElement(MobRow, { key: i, m })))), /* @__PURE__ */ React.createElement("div", { className: "gap" }));
}
const FOODS = [
  { name: "Chicken Breast (6oz)", cals: 185, protein: 35, carbs: 0, fat: 4 },
  { name: "Greek Yogurt (1 cup)", cals: 130, protein: 22, carbs: 9, fat: 0 },
  { name: "Eggs (2 large)", cals: 140, protein: 12, carbs: 0, fat: 10 },
  { name: "Brown Rice (1 cup)", cals: 215, protein: 5, carbs: 45, fat: 2 },
  { name: "Banana", cals: 105, protein: 1, carbs: 27, fat: 0 },
  { name: "Cottage Cheese (\xBDc)", cals: 90, protein: 12, carbs: 4, fat: 2 },
  { name: "Almonds (1oz)", cals: 160, protein: 6, carbs: 6, fat: 14 },
  { name: "Salmon (5oz)", cals: 250, protein: 35, carbs: 0, fat: 12 },
  { name: "Oatmeal (\xBDc dry)", cals: 150, protein: 5, carbs: 27, fat: 3 },
  { name: "Protein Shake", cals: 130, protein: 25, carbs: 5, fat: 2 },
  { name: "Sweet Potato (med)", cals: 130, protein: 3, carbs: 30, fat: 0 },
  { name: "Broccoli (2 cups)", cals: 60, protein: 5, carbs: 12, fat: 0 },
  { name: "Ground Beef 93% (5oz)", cals: 215, protein: 30, carbs: 0, fat: 10 },
  { name: "Whole Milk (1 cup)", cals: 150, protein: 8, carbs: 12, fat: 8 }
];
function NutritionTab({ nutrition, setNutrition }) {
  const today = (/* @__PURE__ */ new Date()).toDateString();
  const tl = nutrition.find((n) => n.date === today) || { date: today, cals: 0, protein: 0, fat: 0, carbs: 0, items: [] };
  const [view, setView] = useState("today");
  const [c, setC] = useState({ name: "", cals: "", protein: "", fat: "", carbs: "" });
  const add = async (food) => {
    const u = __spreadProps(__spreadValues({}, tl), { cals: tl.cals + food.cals, protein: tl.protein + food.protein, fat: tl.fat + food.fat, carbs: tl.carbs + food.carbs, items: [...tl.items || [], food.name] });
    const nn = [u, ...nutrition.filter((n) => n.date !== today)];
    setNutrition(nn);
    await sset("nutrition", nn);
  };
  const addC = () => {
    if (!c.name || !c.cals) return;
    add({ name: c.name, cals: +c.cals, protein: +c.protein || 0, fat: +c.fat || 0, carbs: +c.carbs || 0 });
    setC({ name: "", cals: "", protein: "", fat: "", carbs: "" });
  };
  const left = USER.targetCals - tl.cals;
  return /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "FUEL"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, "Flexible tracking \xB7 ", USER.targetCals, " cal target")), /* @__PURE__ */ React.createElement("div", { className: "tabs" }, /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "today" ? "on" : ""}`, onClick: () => setView("today") }, "Today"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "log" ? "on" : ""}`, onClick: () => setView("log") }, "Log Food"), /* @__PURE__ */ React.createElement("div", { className: `tab ${view === "targets" ? "on" : ""}`, onClick: () => setView("targets") }, "Targets")), view === "today" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Today's Totals"), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", justifyContent: "space-around", textAlign: "center", marginBottom: 16 } }, [{ v: tl.cals, l: "Eaten", c: left < 0 ? "var(--red)" : "var(--lime)" }, { v: Math.max(left, 0), l: "Left", c: "var(--t2)" }, { v: `${tl.protein}g`, l: "Protein", c: "var(--blue)" }].map((s, i) => /* @__PURE__ */ React.createElement("div", { key: i }, /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 36, color: s.c, lineHeight: 1 } }, s.v), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 10, color: "var(--t3)", marginTop: 3, textTransform: "uppercase" } }, s.l)))), /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Protein"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.protein / USER.protein * 100, 100)}%`, background: "var(--blue)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.protein, "/", USER.protein, "g")), /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Carbs"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.carbs / USER.carbs * 100, 100)}%`, background: "var(--purple)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.carbs, "/", USER.carbs, "g")), /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Fat"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.fat / USER.fat * 100, 100)}%`, background: "var(--amber)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.fat, "/", USER.fat, "g"))), (tl.items || []).length > 0 && /* @__PURE__ */ React.createElement("div", { className: "card" }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Logged Today"), (tl.items || []).map((item, i) => /* @__PURE__ */ React.createElement("div", { key: i, style: { fontSize: 13, padding: "6px 0", borderBottom: "1px solid var(--border)", color: "var(--t2)" } }, item))), /* @__PURE__ */ React.createElement("div", { className: "co lime", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--lime)" } }, "\u{1F4A1} Protein First"), /* @__PURE__ */ React.createElement("br", null), "At 56, ", USER.protein, "g protein daily preserves muscle during fat loss. Aim 40\u201350g per meal, 3\u20134 meals.")), view === "log" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "card", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Quick Add"), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", flexWrap: "wrap" } }, FOODS.map((f, i) => /* @__PURE__ */ React.createElement("span", { key: i, className: "pill", onClick: () => add(f) }, "+ ", f.name)))), /* @__PURE__ */ React.createElement("div", { className: "card" }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Custom Entry"), /* @__PURE__ */ React.createElement("div", { className: "ig" }, /* @__PURE__ */ React.createElement("label", { className: "ilbl" }, "Food Name"), /* @__PURE__ */ React.createElement("input", { className: "inp", placeholder: "e.g. Ribeye 8oz", value: c.name, onChange: (e) => setC((p) => __spreadProps(__spreadValues({}, p), { name: e.target.value })) })), /* @__PURE__ */ React.createElement("div", { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } }, /* @__PURE__ */ React.createElement("div", { className: "ig" }, /* @__PURE__ */ React.createElement("label", { className: "ilbl" }, "Calories"), /* @__PURE__ */ React.createElement("input", { className: "inp", type: "number", inputMode: "decimal", placeholder: "400", value: c.cals, onChange: (e) => setC((p) => __spreadProps(__spreadValues({}, p), { cals: e.target.value })) })), /* @__PURE__ */ React.createElement("div", { className: "ig" }, /* @__PURE__ */ React.createElement("label", { className: "ilbl" }, "Protein (g)"), /* @__PURE__ */ React.createElement("input", { className: "inp", type: "number", inputMode: "decimal", placeholder: "35", value: c.protein, onChange: (e) => setC((p) => __spreadProps(__spreadValues({}, p), { protein: e.target.value })) })), /* @__PURE__ */ React.createElement("div", { className: "ig" }, /* @__PURE__ */ React.createElement("label", { className: "ilbl" }, "Carbs (g)"), /* @__PURE__ */ React.createElement("input", { className: "inp", type: "number", inputMode: "decimal", placeholder: "20", value: c.carbs, onChange: (e) => setC((p) => __spreadProps(__spreadValues({}, p), { carbs: e.target.value })) })), /* @__PURE__ */ React.createElement("div", { className: "ig" }, /* @__PURE__ */ React.createElement("label", { className: "ilbl" }, "Fat (g)"), /* @__PURE__ */ React.createElement("input", { className: "inp", type: "number", inputMode: "decimal", placeholder: "18", value: c.fat, onChange: (e) => setC((p) => __spreadProps(__spreadValues({}, p), { fat: e.target.value })) }))), /* @__PURE__ */ React.createElement("button", { className: "btn full", onClick: addC }, "Add Food"))), view === "targets" && /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", { className: "co lime", style: { marginTop: 10 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--lime)" } }, "Calculated for You"), /* @__PURE__ */ React.createElement("br", null), `56yo male \xB7 5'10" \xB7 198 lb \xB7 lightly active \xB7 fat loss`), /* @__PURE__ */ React.createElement("div", { className: "sg" }, [{ v: USER.tdee, u: "cal", l: "TDEE" }, { v: USER.targetCals, u: "cal", l: "Daily Target", c: "var(--lime)" }, { v: USER.protein, u: "g", l: "Protein", c: "var(--blue)" }, { v: USER.carbs, u: "g", l: "Carbs", c: "var(--purple)" }, { v: USER.fat, u: "g", l: "Fat", c: "var(--amber)" }, { v: "~0.5", u: "lb/wk", l: "Expected Loss" }].map((s, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: "sc", style: { cursor: "default" } }, /* @__PURE__ */ React.createElement("div", { className: "sv", style: { color: s.c || "var(--text)" } }, s.v, /* @__PURE__ */ React.createElement("span", { className: "su" }, s.u)), /* @__PURE__ */ React.createElement("div", { className: "sl" }, s.l)))), /* @__PURE__ */ React.createElement("div", { className: "co blue", style: { marginTop: 4 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--blue)" } }, "Flexible Tracking"), /* @__PURE__ */ React.createElement("br", null), "\xB110% of targets most days. Consistency over weeks beats single-day perfection.")), /* @__PURE__ */ React.createElement("div", { className: "gap" }));
}
function Dashboard({ history, nutrition, setTab }) {
  const today = /* @__PURE__ */ new Date();
  const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
  const week = Array.from({ length: 7 }, (_, i) => {
    const d = new Date(today);
    d.setDate(today.getDate() - today.getDay() + i);
    return { name: days[i], num: d.getDate(), isToday: d.toDateString() === today.toDateString(), trained: history.some((h) => h.date === d.toDateString()) };
  });
  const tl = nutrition.find((n) => n.date === today.toDateString()) || { cals: 0, protein: 0, fat: 0, carbs: 0 };
  const now = /* @__PURE__ */ new Date(), sow = new Date(now);
  sow.setDate(now.getDate() - now.getDay());
  sow.setHours(0, 0, 0, 0);
  const wkStr = history.filter((h) => h.type === "strength" && new Date(h.date) >= sow).length;
  const totSess = history.filter((h) => h.type === "strength").length;
  const deload = needsDeload(history);
  const lastW = history.filter((h) => h.type === "strength")[0];
  const nextW = (lastW == null ? void 0 : lastW.workout) === "A" ? "B" : "A";
  return /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "flex-start" } }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "TODAY"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, today.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric" }))), /* @__PURE__ */ React.createElement("div", { style: { textAlign: "right" } }, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 9, color: "var(--t3)", letterSpacing: ".8px" } }, "WEEK"), /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 32, color: "var(--lime)", lineHeight: 1 } }, Math.ceil((totSess + 1) / 3))))), /* @__PURE__ */ React.createElement("div", { className: "week" }, week.map((d) => /* @__PURE__ */ React.createElement("div", { key: d.name, className: `dc ${d.isToday ? "today" : ""} ${d.trained && !d.isToday ? "trained" : ""}` }, /* @__PURE__ */ React.createElement("span", { className: "dn" }, d.name), /* @__PURE__ */ React.createElement("span", { className: "dd" }, d.num), d.isToday && /* @__PURE__ */ React.createElement("span", { className: "dot" })))), deload && /* @__PURE__ */ React.createElement("div", { className: "dlb" }, /* @__PURE__ */ React.createElement("span", { style: { fontSize: 20 } }, "\u{1F504}"), /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { style: { fontWeight: 700, color: "var(--amber)", marginBottom: 3 } }, "Deload Week"), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t2)" } }, "Reduce weights ~40% this week. Your body needs it."))), /* @__PURE__ */ React.createElement("div", { className: "card" }, /* @__PURE__ */ React.createElement("div", { className: "clbl" }, "Nutrition Today"), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", alignItems: "center", gap: 16 } }, /* @__PURE__ */ React.createElement(Ring, { value: tl.cals, max: USER.targetCals, size: 88, stroke: 8, color: "var(--lime)" }, /* @__PURE__ */ React.createElement("div", { style: { fontFamily: "var(--fd)", fontSize: 18, lineHeight: 1 } }, tl.cals), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 10, color: "var(--t3)" } }, "/", USER.targetCals)), /* @__PURE__ */ React.createElement("div", { style: { flex: 1 } }, /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Protein"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.protein / USER.protein * 100, 100)}%`, background: "var(--blue)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.protein, "/", USER.protein, "g")), /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Carbs"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.carbs / USER.carbs * 100, 100)}%`, background: "var(--purple)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.carbs, "/", USER.carbs, "g")), /* @__PURE__ */ React.createElement("div", { className: "mr" }, /* @__PURE__ */ React.createElement("span", { className: "mn" }, "Fat"), /* @__PURE__ */ React.createElement("div", { className: "mb" }, /* @__PURE__ */ React.createElement("div", { className: "mf", style: { width: `${Math.min(tl.fat / USER.fat * 100, 100)}%`, background: "var(--amber)" } })), /* @__PURE__ */ React.createElement("span", { className: "mv" }, tl.fat, "/", USER.fat, "g")))), /* @__PURE__ */ React.createElement("button", { className: "btn sm full", style: { marginTop: 12 }, onClick: () => setTab("nutrition") }, "+ Log Food")), /* @__PURE__ */ React.createElement("div", { className: "sg" }, /* @__PURE__ */ React.createElement("div", { className: "sc", onClick: () => setTab("strength") }, /* @__PURE__ */ React.createElement("div", { className: "sv", style: { color: "var(--lime)" } }, wkStr, /* @__PURE__ */ React.createElement("span", { className: "su" }, "/3")), /* @__PURE__ */ React.createElement("div", { className: "sl" }, "Lifts This Week")), /* @__PURE__ */ React.createElement("div", { className: "sc" }, /* @__PURE__ */ React.createElement("div", { className: "sv" }, totSess), /* @__PURE__ */ React.createElement("div", { className: "sl" }, "Total Sessions"))), /* @__PURE__ */ React.createElement("div", { className: "pb" }, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 28 } }, "\u{1F4AA}"), /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { style: { fontSize: 9, color: "var(--t3)", letterSpacing: ".8px", marginBottom: 3 } }, "NEXT UP"), /* @__PURE__ */ React.createElement("div", { style: { fontWeight: 700, fontSize: 15 } }, "Workout ", nextW), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 12, color: "var(--t2)", marginTop: 2 } }, "8 exercises + Limber 11 \xB7 ~55 min"), /* @__PURE__ */ React.createElement("div", { style: { display: "flex", gap: 8, marginTop: 10, flexWrap: "wrap" } }, /* @__PURE__ */ React.createElement("button", { className: "btn sm", onClick: () => setTab("strength") }, "Start Workout \u2192"), /* @__PURE__ */ React.createElement("button", { className: "btn sm ghost", onClick: () => setTab("mobility") }, "Morning Mobility")))), /* @__PURE__ */ React.createElement("div", { className: "co teal", style: { marginTop: 12 } }, /* @__PURE__ */ React.createElement("strong", { style: { color: "var(--teal)" } }, "\u{1F4CA} Your North Star"), /* @__PURE__ */ React.createElement("br", null), "2 years of vigorous exercise reversed 20 years of heart aging in sedentary 50-year-olds. VO\u2082 max is your most important longevity metric. Norwegian 4\xD74 is your fastest path to improving it."), /* @__PURE__ */ React.createElement("div", { className: "gap" }));
}
function CoachTab({ history, weights }) {
  const [msgs, setMsgs] = useState([{ role: "assistant", text: `Hey! I'm your AI fitness coach. I've read your full exercise library, Raindrop bookmarks, and know your complete profile \u2014 56yo male, desk worker, tight hips, solo training, home gym. I also track your workout history and current weights. What can I help with?` }]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const SUGG = ["How do I progress dead hangs to pull-ups?", "Best hip mobility routine for desk workers?", "Should I increase my KB swing weight?", "How do box jumps fit into my program?", "What's the science behind Norwegian 4x4?"];
  const send = async (msg) => {
    const txt = msg || input.trim();
    if (!txt || loading) return;
    setInput("");
    setMsgs((m) => [...m, { role: "user", text: txt }]);
    setLoading(true);
    const recent = history.filter((h) => h.type === "strength").slice(0, 4).map((s) => ({ date: s.date, workout: s.workout, fails: s.sets ? Object.values(s.sets).flat().filter((x) => x.status === "fail").length : 0, dones: s.sets ? Object.values(s.sets).flat().filter((x) => x.status === "done").length : 0 }));
    try {
      const res = await fetch("https://api.anthropic.com/v1/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1e3,
        system: `You are a personal fitness and nutrition AI coach. Be specific, evidence-based, and encouraging.

USER PROFILE:
- 56yo male, 5'10", 198 lbs, intermediate lifter, desk worker (sits all day)
- Goal: fat loss + muscle preservation. Targets: ${USER.targetCals} cal, ${USER.protein}g protein, ${USER.carbs}g carbs, ${USER.fat}g fat
- Equipment: barbell + bench (solo \u2014 RPE 7 max), dumbbells, kettlebells, pull-up bar, elliptical, punching bag
- Known issues: shoulder (avoid heavy overhead), tight hips and hamstrings (can't touch toes), lower back sensitivity
- Interests from bookmarks: kettlebell training, ATG/knee-over-toe, Peter Attia longevity protocols, Huberman Lab, Norwegian 4x4, BJJ/martial arts, VO\u2082 max

PROGRAM:
- A/B full body strength 3x/week (main lifts consistent + rotating accessories)
- 5 cardio protocols: Norwegian 4\xD74, Heavy Bag HIIT, KB Complex, Huberman Assault Bike, Japanese Interval Walk
- Mobility: Limber 11 pre-workout, morning CARs routine, hip mobility priority, BJJ shoulder stretch
- Progression: confirm before applying. 2 fails = 10% deweight. Deload every 4 weeks or performance-triggered.
- Cardio HR zone: ${HR_LOW}\u2013${HR_HIGH} bpm (max HR ${MAX_HR})

RECENT SESSIONS: ${JSON.stringify(recent)}
WORKING WEIGHTS: ${JSON.stringify(weights)}

Keep responses under 200 words. Prioritize joint health, longevity, and sustainable progress for a 56yo solo trainer. Reference specific exercises, protocols, or resources from their library when relevant.`,
        messages: [...msgs.map((m) => ({ role: m.role === "assistant" ? "assistant" : "user", content: m.text })), { role: "user", content: txt }]
      }) });
      const data = await res.json();
      setMsgs((m) => {
        var _a;
        return [...m, { role: "assistant", text: ((_a = data.content) == null ? void 0 : _a.map((c) => c.text).join("")) || "Couldn't connect." }];
      });
    } catch (e) {
      setMsgs((m) => [...m, { role: "assistant", text: "Connection error. Please try again." }]);
    }
    setLoading(false);
  };
  return /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph" }, /* @__PURE__ */ React.createElement("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "flex-start" } }, /* @__PURE__ */ React.createElement("div", null, /* @__PURE__ */ React.createElement("div", { className: "ph-title" }, "COACH"), /* @__PURE__ */ React.createElement("div", { className: "ph-sub" }, "AI \xB7 knows your full profile")), /* @__PURE__ */ React.createElement("div", { style: { fontSize: 32 } }, "\u{1F916}"))), msgs.length <= 1 && /* @__PURE__ */ React.createElement("div", { style: { padding: "10px 16px 0", display: "flex", flexWrap: "wrap" } }, SUGG.map((s, i) => /* @__PURE__ */ React.createElement("span", { key: i, className: "pill", onClick: () => send(s) }, s))), /* @__PURE__ */ React.createElement("div", { style: { padding: "12px 16px 0" } }, msgs.map((m, i) => /* @__PURE__ */ React.createElement("div", { key: i, className: `bubble fade ${m.role === "user" ? "user" : ""}` }, m.text)), loading && /* @__PURE__ */ React.createElement("div", { className: "bubble" }, /* @__PURE__ */ React.createElement("span", { className: "spin", style: { width: 14, height: 14 } }), /* @__PURE__ */ React.createElement("span", { style: { fontSize: 12, color: "var(--t2)", marginLeft: 8 } }, "Thinking..."))), /* @__PURE__ */ React.createElement("div", { style: { padding: "10px 16px", display: "flex", gap: 8, position: "sticky", bottom: "calc(var(--nav) + 6px)" } }, /* @__PURE__ */ React.createElement("input", { className: "inp", placeholder: "Ask anything...", value: input, onChange: (e) => setInput(e.target.value), onKeyDown: (e) => e.key === "Enter" && send() }), /* @__PURE__ */ React.createElement("button", { className: "btn", onClick: () => send(), disabled: loading || !input.trim() }, "Send")));
}
function App() {
  const [tab, setTab] = useState("home");
  const [history, setHistory] = useState([]);
  const [nutrition, setNutrition] = useState([]);
  const [weights, setWeights] = useState(__spreadValues({}, DW));
  const [loaded, setLoaded] = useState(false);
  useEffect(() => {
    (async () => {
      const h = await sget("history");
      if (h) setHistory(h);
      const n = await sget("nutrition");
      if (n) setNutrition(n);
      const w = await sget("weights");
      if (w) setWeights(__spreadValues(__spreadValues({}, DW), w));
      setLoaded(true);
    })();
  }, []);
  if (!loaded) return /* @__PURE__ */ React.createElement("div", { style: { display: "flex", alignItems: "center", justifyContent: "center", height: "100vh", background: "#090909", fontFamily: "DM Sans,sans-serif", color: "#55555f", gap: 12 } }, /* @__PURE__ */ React.createElement("span", { className: "spin", style: { width: 22, height: 22 } }), " Loading...");
  const TABS = [
    { id: "home", lbl: "Home", ic: Ic.home },
    { id: "strength", lbl: "Lift", ic: Ic.lift },
    { id: "cardio", lbl: "Cardio", ic: Ic.heart },
    { id: "mobility", lbl: "Move", ic: Ic.leaf },
    { id: "nutrition", lbl: "Fuel", ic: Ic.fire },
    { id: "coach", lbl: "Coach", ic: Ic.bot }
  ];
  return /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("style", null, STYLE), /* @__PURE__ */ React.createElement("div", { className: "app" }, /* @__PURE__ */ React.createElement("div", { className: "main" }, tab === "home" && /* @__PURE__ */ React.createElement(Dashboard, { history, nutrition, setTab }), tab === "strength" && /* @__PURE__ */ React.createElement(StrengthTab, { history, setHistory, weights, setWeights }), tab === "cardio" && /* @__PURE__ */ React.createElement(CardioTab, { history, setHistory }), tab === "mobility" && /* @__PURE__ */ React.createElement(MobilityTab, null), tab === "nutrition" && /* @__PURE__ */ React.createElement(NutritionTab, { nutrition, setNutrition }), tab === "coach" && /* @__PURE__ */ React.createElement(CoachTab, { history, weights })), /* @__PURE__ */ React.createElement("nav", { className: "nav" }, TABS.map((t) => /* @__PURE__ */ React.createElement("button", { key: t.id, className: `nb ${tab === t.id ? "on" : ""}`, onClick: () => setTab(t.id) }, t.ic, /* @__PURE__ */ React.createElement("span", null, t.lbl))))));
}

  </script>

  <!-- Quagga2: JS barcode scanner (Safari/iOS fallback — BarcodeDetector is Chromium-only) -->
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

  <script>
  // ============================================================
  // Sprint 1 — Camera Barcode Scanner for Nutrition
  // Chrome: native BarcodeDetector API
  // Safari/iOS: Quagga2 library (BarcodeDetector not in WebKit)
  // Open Food Facts API (free, no key) for nutrition lookup
  // ============================================================

  function BarcodeScanner({ onAdd, onClose, onRescan, onSave, addLabel = '+ Add to Log', onScanLabel }) {
    const hasNative = 'BarcodeDetector' in window;
    const [phase, setPhase] = React.useState('init');
    // phases: init | scanning | loading | found | notfound | error | unsupported
    const [food, setFood] = React.useState(null);
    const [grams, setGrams] = React.useState('100');
    const [errMsg, setErrMsg] = React.useState('');
    const videoRef = React.useRef(null);
    const streamRef = React.useRef(null);
    const quaggaRef = React.useRef(null);
    const activeRef = React.useRef(true);

    const stopCamera = () => {
      activeRef.current = false;
      if (streamRef.current) {
        streamRef.current.getTracks().forEach(t => t.stop());
        streamRef.current = null;
      }
      if (videoRef.current) videoRef.current.srcObject = null;
    };

    const lookup = async (barcode) => {
      setPhase('loading');
      const setFound = (f) => { setFood(f); setGrams(String(Math.round(f.servingQty))); setPhase('found'); };

      // 1. Open Food Facts
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        if (res.ok) {
          const data = await res.json();
          if (data.status === 1 && data.product) {
            const p = data.product; const n = p.nutriments || {};
            const servingQty = parseFloat(p.serving_quantity) || 100;
            return setFound({
              name: (p.product_name || p.generic_name || 'Scanned Product').trim(),
              cals100: Math.round(n['energy-kcal_100g'] || n['energy-kcal'] || 0),
              protein100: +((n.proteins_100g || 0).toFixed(1)),
              carbs100: +((n.carbohydrates_100g || 0).toFixed(1)),
              fat100: +((n.fat_100g || 0).toFixed(1)),
              servingSize: p.serving_size || `${Math.round(servingQty)}g`,
              servingQty, barcode, source: 'Open Food Facts',
            });
          }
        }
      } catch(e) {}

      // 2. USDA FoodData Central (free, no key required, good branded supplement coverage)
      try {
        const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(barcode)}&api_key=DEMO_KEY&dataType=Branded&pageSize=1`);
        if (res.ok) {
          const data = await res.json();
          const f = data.foods && data.foods[0];
          if (f) {
            const nmap = {};
            (f.foodNutrients || []).forEach(n => { nmap[n.nutrientId] = n.value; });
            const servingQty = f.servingSize || 100;
            const unit = (f.servingSizeUnit || 'g').toLowerCase();
            // USDA FDC branded nutrients are per 100g
            // Capture micros silently (per 100g); vitD in mcg→IU (×40), omega3 EPA(1278)+DHA(1272) g→mg (×1000)
            const micros100 = {
              fiber:     +((nmap[1079] || 0).toFixed(1)),
              vitD:      Math.round((nmap[1114] || 0) * 40),
              vitK:      +((nmap[1185] || 0).toFixed(1)),
              omega3:    Math.round(((nmap[1278] || 0) + (nmap[1272] || 0)) * 1000),
              magnesium: Math.round(nmap[1090] || 0),
              calcium:   Math.round(nmap[1087] || 0),
              zinc:      +((nmap[1095] || 0).toFixed(1)),
              b12:       +((nmap[1178] || 0).toFixed(2)),
              vitC:      Math.round(nmap[1162] || 0),
              potassium: Math.round(nmap[1092] || 0),
            };
            return setFound({
              name: (f.description || 'Scanned Product').split(',')[0].trim(),
              cals100: Math.round(nmap[1008] || nmap[1062] || 0),
              protein100: +((nmap[1003] || 0).toFixed(1)),
              carbs100: +((nmap[1005] || 0).toFixed(1)),
              fat100: +((nmap[1004] || 0).toFixed(1)),
              servingSize: `${servingQty}${unit}`,
              servingQty: unit === 'g' ? servingQty : 100,
              micros100,
              barcode, source: 'USDA',
            });
          }
        }
      } catch(e) {}

      // Not found in any database
      setErrMsg('Not found in food databases. Scan the label or enter manually.');
      setPhase('notfound');
    };

    React.useEffect(() => {
      if (hasNative) {
        // ── Native BarcodeDetector path (Chrome/Chromium) ──────
        if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
          setPhase('error');
          setErrMsg('Camera is not accessible. Try opening in a different browser.');
          return;
        }
        let detector;
        let scanTimer = null;
        const preferred = ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf'];
        const getFormats = typeof BarcodeDetector.getSupportedFormats === 'function'
          ? BarcodeDetector.getSupportedFormats()
          : Promise.resolve([]);
        getFormats
          .then(supported => {
            const formats = preferred.filter(f => supported.includes(f));
            try {
              detector = formats.length ? new BarcodeDetector({ formats }) : new BarcodeDetector();
            } catch(e) {
              setPhase('unsupported');
              return Promise.reject({ name: '_stop' });
            }
            return navigator.mediaDevices.getUserMedia({
              video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
            });
          })
          .then(stream => {
            if (!activeRef.current) { stream.getTracks().forEach(t => t.stop()); return; }
            streamRef.current = stream;
            const video = videoRef.current;
            if (!video) { stream.getTracks().forEach(t => t.stop()); return; }
            video.srcObject = stream;
            video.setAttribute('playsinline', '');
            return video.play();
          })
          .then(() => {
            if (!activeRef.current) return;
            setPhase('scanning');
            const video = videoRef.current;
            const scan = async () => {
              if (!activeRef.current || !video) return;
              try {
                const codes = await detector.detect(video);
                if (codes.length > 0 && activeRef.current) {
                  stopCamera();
                  lookup(codes[0].rawValue);
                  return;
                }
              } catch(e) { /* frame not ready yet */ }
              if (activeRef.current) scanTimer = setTimeout(scan, 250);
            };
            scanTimer = setTimeout(scan, 600);
          })
          .catch(err => {
            if (!activeRef.current || err.name === '_stop') return;
            setPhase('error');
            setErrMsg(err.name === 'NotAllowedError'
              ? 'Camera access denied.\n\nSettings → Privacy & Security → Camera → turn on for Safari.'
              : `Camera error (${err.name || 'unknown'}).`
            );
          });
        return () => {
          if (scanTimer) clearTimeout(scanTimer);
          stopCamera();
        };

      } else {
        // ── Quagga2 path (Safari / iOS) ────────────────────────
        if (!window.Quagga) {
          setPhase('error');
          setErrMsg('Barcode scanner library failed to load.\n\nCheck your connection and reload the app.');
          return;
        }
        const container = quaggaRef.current;
        if (!container) return;
        let stopped = false;
        const stopQ = () => {
          if (!stopped) { stopped = true; try { window.Quagga.stop(); } catch(e) {} }
        };
        window.Quagga.init({
          inputStream: {
            name: 'Live',
            type: 'LiveStream',
            target: container,
            constraints: { facingMode: 'environment' }
          },
          locator: { patchSize: 'medium', halfSample: true },
          numOfWorkers: 0,
          decoder: {
            readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader']
          }
        }, function(err) {
          if (!activeRef.current) { stopQ(); return; }
          if (err) {
            const eName = err && err.name ? err.name : String(err);
            setPhase('error');
            setErrMsg(eName === 'NotAllowedError'
              ? 'Camera access denied.\n\nSettings → Privacy & Security → Camera → turn on for Safari, then tap Try Again.'
              : `Camera error: ${eName}. Try reloading the app.`
            );
            return;
          }
          window.Quagga.start();
          setPhase('scanning');
          // hide Quagga's debug canvas, keep only our frame overlay
          const cv = container.querySelector('canvas.drawingBuffer');
          if (cv) cv.style.display = 'none';
        });
        window.Quagga.onDetected(function onDetect(result) {
          if (!activeRef.current) return;
          activeRef.current = false;
          window.Quagga.offDetected(onDetect);
          stopQ();
          lookup(result.codeResult.code);
        });
        return () => {
          activeRef.current = false;
          stopQ();
        };
      }
    }, []);

    const handleAdd = () => {
      const g = parseFloat(grams) || 100;
      const scale = g / 100;
      const r1 = v => Math.round(v * 10) / 10;
      // Scale food micros by actual serving size
      let micros = {};
      if (food.micros100) {
        Object.entries(food.micros100).forEach(([key, val]) => {
          const scaled = val * scale;
          micros[key] = key === 'fiber' || key === 'b12' || key === 'zinc' || key === 'vitK'
            ? +scaled.toFixed(key === 'b12' ? 2 : 1)
            : Math.round(scaled);
        });
      }
      onAdd({
        name: `${food.name} (${g}g)`,
        cals: Math.round(food.cals100 * scale),
        protein: r1(food.protein100 * scale),
        carbs: r1(food.carbs100 * scale),
        fat: r1(food.fat100 * scale),
        micros,
      });
      // Save raw per-100g data to My Foods for future quick-add
      if (onSave) onSave({
        name: food.name, cals100: food.cals100, protein100: food.protein100,
        carbs100: food.carbs100, fat100: food.fat100,
        defaultGrams: g, barcode: food.barcode || null,
      });
      onClose();
    };

    const g = parseFloat(grams) || 100;
    const scale = g / 100;
    const r1 = v => Math.round(v * 10) / 10;

    // Shared full-screen overlay wrapper with close button
    const wrap = (body) => React.createElement('div', {
      style: { position: 'fixed', inset: 0, background: '#000', zIndex: 400, display: 'flex', flexDirection: 'column' }
    },
      React.createElement('div', {
        style: {
          position: 'absolute', top: 0, left: 0, right: 0, zIndex: 2,
          padding: 'max(20px, env(safe-area-inset-top)) 16px 16px',
          display: 'flex', justifyContent: 'space-between', alignItems: 'center',
          background: 'linear-gradient(to bottom, rgba(0,0,0,.8) 0%, transparent 100%)'
        }
      },
        React.createElement('div', { style: { color: '#fff', fontWeight: 700, fontSize: 16 } }, 'Scan Food Barcode'),
        React.createElement('button', {
          onClick: onClose,
          style: { background: 'rgba(255,255,255,.18)', border: 'none', borderRadius: '50%', width: 34, height: 34, color: '#fff', fontSize: 18, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }
        }, '✕')
      ),
      body
    );

    // ── Scanning view ───────────────────────────────────────
    if (phase === 'init' || phase === 'scanning') {
      return wrap(React.createElement(React.Fragment, null,
        hasNative
          ? React.createElement('video', {
              ref: videoRef,
              style: { width: '100%', height: '100%', objectFit: 'cover' },
              playsInline: true, muted: true, autoPlay: true
            })
          : React.createElement('div', {
              ref: quaggaRef,
              style: { width: '100%', height: '100%', overflow: 'hidden', position: 'relative' }
            }),
        React.createElement('div', {
          style: { position: 'absolute', inset: 0, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', pointerEvents: 'none', zIndex: 1 }
        },
          React.createElement('div', {
            style: { width: 260, height: 150, borderRadius: 10, border: '2px solid #c8f135', boxShadow: '0 0 0 9999px rgba(0,0,0,.5)', position: 'relative' }
          },
            ...['tl','tr','bl','br'].map(pos => React.createElement('div', { key: pos, style: {
              position: 'absolute', width: 18, height: 18, borderStyle: 'solid', borderColor: '#c8f135',
              borderTopWidth: pos[0]==='t' ? 3 : 0, borderBottomWidth: pos[0]==='b' ? 3 : 0,
              borderLeftWidth: pos[1]==='l' ? 3 : 0, borderRightWidth: pos[1]==='r' ? 3 : 0,
              top: pos[0]==='t' ? -1 : 'auto', bottom: pos[0]==='b' ? -1 : 'auto',
              left: pos[1]==='l' ? -1 : 'auto', right: pos[1]==='r' ? -1 : 'auto',
              borderRadius: pos==='tl'?'4px 0 0 0':pos==='tr'?'0 4px 0 0':pos==='bl'?'0 0 0 4px':'0 0 4px 0'
            }}))
          ),
          React.createElement('div', {
            style: { color: '#c8f135', fontSize: 13, fontWeight: 600, marginTop: 18, letterSpacing: 1, textShadow: '0 1px 6px rgba(0,0,0,.9)' }
          }, phase === 'scanning' ? 'Point at barcode' : 'Starting camera...')
        )
      ));
    }

    // ── Loading view ────────────────────────────────────────
    if (phase === 'loading') {
      return wrap(React.createElement('div', {
        style: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#090909', gap: 16 }
      },
        React.createElement('span', { className: 'spin', style: { width: 36, height: 36 } }),
        React.createElement('div', { style: { color: '#9090a0', fontSize: 14 } }, 'Looking up barcode...')
      ));
    }

    // ── Found view ──────────────────────────────────────────
    if (phase === 'found' && food) {
      return wrap(React.createElement('div', {
        style: { flex: 1, overflow: 'auto', background: '#090909', padding: '72px 16px 24px', WebkitOverflowScrolling: 'touch' }
      },
        React.createElement('div', { className: 'co lime', style: { margin: '0 0 12px' } },
          React.createElement('strong', { style: { color: '#c8f135', fontSize: 15 } }, food.name),
          React.createElement('br'),
          React.createElement('span', { style: { fontSize: 11, color: '#9090a0' } }, `Serving: ${food.servingSize}`)
        ),
        React.createElement('div', { className: 'card', style: { margin: '0 0 12px' } },
          React.createElement('div', { className: 'clbl' }, 'Per 100g'),
          ...[
            { lbl: 'Calories', val: food.cals100, unit: ' kcal', max: 500, color: '#c8f135' },
            { lbl: 'Protein',  val: food.protein100, unit: 'g', max: 50, color: '#3fb8f5' },
            { lbl: 'Carbs',    val: food.carbs100, unit: 'g', max: 100, color: '#b06af5' },
            { lbl: 'Fat',      val: food.fat100, unit: 'g', max: 50, color: '#f5a83f' },
          ].map(m => React.createElement('div', { key: m.lbl, className: 'mr' },
            React.createElement('span', { className: 'mn' }, m.lbl),
            React.createElement('div', { className: 'mb' },
              React.createElement('div', { className: 'mf', style: { width: `${Math.min(m.val / m.max * 100, 100)}%`, background: m.color } })
            ),
            React.createElement('span', { className: 'mv' }, `${m.val}${m.unit}`)
          ))
        ),
        React.createElement('div', { className: 'card', style: { margin: '0 0 16px' } },
          React.createElement('div', { className: 'clbl' }, 'Your Portion'),
          React.createElement('div', { className: 'ig' },
            React.createElement('label', { className: 'ilbl' }, 'Amount (grams)'),
            React.createElement('input', { className: 'inp', type: 'number', inputMode: 'decimal', value: grams, min: 1, step: 5, onChange: e => setGrams(e.target.value) })
          ),
          React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4,1fr)', gap: 8, textAlign: 'center', paddingTop: 4 } },
            ...[
              { v: Math.round(food.cals100 * scale), l: 'cal', c: '#c8f135' },
              { v: `${r1(food.protein100 * scale)}g`, l: 'protein', c: '#3fb8f5' },
              { v: `${r1(food.carbs100 * scale)}g`, l: 'carbs', c: '#b06af5' },
              { v: `${r1(food.fat100 * scale)}g`, l: 'fat', c: '#f5a83f' },
            ].map((s, i) => React.createElement('div', { key: i },
              React.createElement('div', { style: { fontFamily: "'Bebas Neue',sans-serif", fontSize: 22, color: s.c, lineHeight: 1 } }, s.v),
              React.createElement('div', { style: { fontSize: 9, color: '#55555f', textTransform: 'uppercase', letterSpacing: '.5px', marginTop: 2 } }, s.l)
            ))
          )
        ),
        React.createElement('div', { style: { display: 'flex', gap: 10 } },
          React.createElement('button', { className: 'btn ghost', onClick: onRescan }, 'Rescan'),
          React.createElement('button', { className: 'btn', style: { flex: 1, justifyContent: 'center' }, onClick: handleAdd }, addLabel)
        )
      ));
    }

    // ── Not found / error / unsupported view ────────────────
    const iconMap = { notfound: '🔍', error: '⚠️', unsupported: '📷' };
    const unsupportedMsg = 'Barcode scanning requires iOS 17+ with Safari.\n\nUpdate your iOS or use Quick Add / Custom Entry.';
    return wrap(React.createElement('div', {
      style: { flex: 1, background: '#090909', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 28, gap: 16, textAlign: 'center' }
    },
      React.createElement('div', { style: { fontSize: 44 } }, iconMap[phase] || '⚠️'),
      React.createElement('div', { style: { color: '#9090a0', fontSize: 14, lineHeight: 1.75, maxWidth: 300, whiteSpace: 'pre-line' } },
        phase === 'unsupported' ? unsupportedMsg : errMsg
      ),
      phase !== 'unsupported' && React.createElement('button', { className: 'btn ghost', onClick: onRescan }, 'Try Again'),
      phase === 'notfound' && onScanLabel && React.createElement('button', {
        className: 'btn ghost',
        style: { borderColor: 'var(--blue)', color: 'var(--blue)' },
        onClick: () => { onClose(); onScanLabel(); }
      }, '📸 Scan Label Instead'),
      React.createElement('button', { className: 'btn', onClick: onClose }, 'Enter Manually')
    ));
  }

  // ============================================================
  // LabelScanner — Claude Vision photo-to-nutrition extraction
  // Takes a photo of any Nutrition Facts / Supplement Facts label,
  // sends to Claude API, returns structured macro data.
  // ============================================================
  function LabelScanner({ onResult, onClose, mode = 'food' }) {
    const [phase, setPhase] = React.useState('idle'); // idle|loading|done|error
    const [result, setResult] = React.useState(null);
    const [errMsg, setErrMsg] = React.useState('');
    const [previewUrl, setPreviewUrl] = React.useState(null);
    const fileRef = React.useRef(null);

    const reset = () => { setPhase('idle'); setResult(null); setErrMsg(''); setPreviewUrl(null); if (fileRef.current) fileRef.current.value = ''; };

    const handleFile = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      setPreviewUrl(URL.createObjectURL(file));
      setPhase('loading');

      // Resize to max 1200px to keep payload manageable
      const toBase64 = () => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const MAX = 1200;
          let w = img.width, h = img.height;
          if (w > MAX || h > MAX) { const r = Math.min(MAX/w, MAX/h); w = Math.round(w*r); h = Math.round(h*r); }
          const cv = document.createElement('canvas');
          cv.width = w; cv.height = h;
          cv.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(cv.toDataURL('image/jpeg', 0.85).split(',')[1]);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });

      try {
        const b64 = await toBase64();
        const apiKey = typeof _getKey === 'function' ? _getKey() : localStorage.getItem('fitlife_anthropic_key') || '';
        if (!apiKey) { setErrMsg('Claude API key not set. Go to the Coach tab to add your key.'); setPhase('error'); return; }

        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
          },
          body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',
            max_tokens: 600,
            messages: [{ role: 'user', content: [
              { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } },
              { type: 'text', text: mode === 'supp'
                ? 'This is a Supplement Facts label. Return ONLY a JSON object, no other text:\n{"name":"product name","serving_g":1,"cals100":0,"protein100":0,"carbs100":0,"fat100":0,"micros_per_serving":{"fiber":0,"vitD":0,"vitK":0,"omega3":0,"magnesium":0,"calcium":0,"zinc":0,"b12":0,"vitC":0,"potassium":0}}\ncals100/protein100/carbs100/fat100 are per 100g (convert from per-serving using the serving size). For capsules/softgels/tablets use serving_g=1. micros_per_serving units: fiber=g, vitD=IU, vitK=mcg, omega3=total EPA+DHA in mg, magnesium/calcium/zinc/vitC/potassium=mg, b12=mcg. Use 0 for any not listed.'
                : 'This is a Nutrition Facts or Supplement Facts label. Extract the data and return ONLY a JSON object, no other text: {"name":"product name","serving_g":30,"cals100":120,"protein100":25,"carbs100":5,"fat100":2} where cals100/protein100/carbs100/fat100 are per 100g (convert from per-serving values using the serving size). For capsules/softgels/tablets use serving_g=1.'
              }
            ]}],
          }),
        });
        if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `API error ${res.status}`); }
        const data = await res.json();
        const text = data.content[0].text;
        // Extract outermost JSON object using brace-depth counting (handles nested objects like micros_per_serving)
        let jsonStr = null;
        const start = text.indexOf('{');
        if (start !== -1) {
          let depth = 0;
          for (let i = start; i < text.length; i++) {
            if (text[i] === '{') depth++;
            else if (text[i] === '}') { depth--; if (depth === 0) { jsonStr = text.slice(start, i + 1); break; } }
          }
        }
        if (!jsonStr) throw new Error('No structured data found in label');
        // Strip trailing commas (LLMs sometimes output them) before parsing
        const cleanJson = jsonStr.replace(/,\s*([}\]])/g, '$1');
        let parsed;
        try { parsed = JSON.parse(cleanJson); }
        catch(pe) { throw new Error(`Label read OK but JSON malformed: ${pe.message}. Raw: ${cleanJson.slice(0, 120)}`); }
        if (parsed.cals100 == null && !parsed.name) throw new Error('Could not read nutrition values');
        if (parsed.cals100 == null) parsed.cals100 = 0;
        setResult(parsed);
        setPhase('done');
      } catch(err) {
        setErrMsg(err.message || 'Failed to read label');
        setPhase('error');
      }
    };

    const wrap = ch => React.createElement('div', {
      style: { position: 'fixed', inset: 0, zIndex: 1000, background: '#090909', display: 'flex', flexDirection: 'column' }
    }, ch);

    if (phase === 'idle') return wrap(React.createElement('div', {
      style: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 32, gap: 20, textAlign: 'center' }
    },
      React.createElement('div', { style: { fontSize: 52 } }, '📸'),
      React.createElement('div', { style: { fontFamily: 'var(--fd)', fontSize: 22, color: 'var(--text)', letterSpacing: 1 } }, 'SCAN LABEL'),
      React.createElement('div', { style: { fontSize: 13, color: 'var(--t3)', maxWidth: 280, lineHeight: 1.7 } },
        mode === 'supp'
          ? 'Photo the Supplement Facts panel. Claude reads it and extracts serving size, calories, and macros.'
          : 'Photo the Nutrition Facts panel. Works on any packaged food or supplement — no barcode needed.'
      ),
      React.createElement('input', { ref: fileRef, type: 'file', accept: 'image/*', capture: 'environment', style: { display: 'none' }, onChange: handleFile }),
      React.createElement('button', { className: 'btn', style: { fontSize: 15, gap: 8, marginTop: 4 }, onClick: () => fileRef.current && fileRef.current.click() }, '📷 Take Photo'),
      React.createElement('button', { className: 'btn ghost', onClick: onClose }, 'Cancel')
    ));

    if (phase === 'loading') return wrap(React.createElement('div', {
      style: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: 20 }
    },
      previewUrl && React.createElement('img', { src: previewUrl, style: { width: 220, height: 160, objectFit: 'cover', borderRadius: 12, opacity: 0.55 } }),
      React.createElement('div', { style: { fontSize: 13, color: 'var(--t3)', lineHeight: 1.6 } }, 'Claude is reading the label…')
    ));

    if (phase === 'error') return wrap(React.createElement('div', {
      style: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 32, gap: 16, textAlign: 'center' }
    },
      React.createElement('div', { style: { fontSize: 44 } }, '⚠️'),
      React.createElement('div', { style: { fontSize: 13, color: '#9090a0', maxWidth: 300, lineHeight: 1.6 } }, errMsg),
      React.createElement('button', { className: 'btn ghost', onClick: reset }, 'Try Again'),
      React.createElement('button', { className: 'btn', onClick: onClose }, 'Enter Manually')
    ));

    // phase === 'done'
    const r = result;
    const g = r.serving_g || 100;
    const scale = g / 100;
    const preview = [
      { v: Math.round(r.cals100 * scale), l: 'cal', c: 'var(--lime)' },
      { v: `${((r.protein100||0) * scale).toFixed(1)}g`, l: 'protein', c: 'var(--blue)' },
      { v: `${((r.carbs100||0) * scale).toFixed(1)}g`, l: 'carbs', c: 'var(--purple)' },
      { v: `${((r.fat100||0) * scale).toFixed(1)}g`, l: 'fat', c: 'var(--amber)' },
    ];
    return wrap(React.createElement('div', { style: { flex: 1, overflowY: 'auto', padding: 20, display: 'flex', flexDirection: 'column', gap: 16 } },
      React.createElement('div', { style: { fontFamily: 'var(--fd)', fontSize: 20, color: 'var(--text)', letterSpacing: .5 } }, 'LABEL READ'),
      previewUrl && React.createElement('img', { src: previewUrl, style: { width: '100%', maxHeight: 160, objectFit: 'cover', borderRadius: 10, opacity: 0.65 } }),
      React.createElement('div', { className: 'card' },
        React.createElement('div', { style: { fontSize: 15, fontWeight: 600, color: 'var(--text)', marginBottom: 4 } }, r.name || 'Scanned Product'),
        React.createElement('div', { style: { fontSize: 11, color: 'var(--t3)', marginBottom: 14 } }, `Per serving · ${g}g`),
        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-around', textAlign: 'center' } },
          ...preview.map((s, i) => React.createElement('div', { key: i },
            React.createElement('div', { style: { fontFamily: 'var(--fd)', fontSize: 28, color: s.c, lineHeight: 1 } }, s.v),
            React.createElement('div', { style: { fontSize: 10, color: 'var(--t3)', textTransform: 'uppercase', marginTop: 2 } }, s.l)
          ))
        ),
        // Show detected micros for supplement mode
        mode === 'supp' && r.micros_per_serving && (() => {
          const detectedMicros = Object.entries(r.micros_per_serving).filter(([,v]) => v > 0);
          if (!detectedMicros.length) return null;
          return React.createElement('div', { style: { marginTop: 12, paddingTop: 12, borderTop: '1px solid var(--border)' } },
            React.createElement('div', { style: { fontSize: 10, color: 'var(--t3)', textTransform: 'uppercase', marginBottom: 6 } }, 'Micronutrients detected'),
            React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 6 } },
              ...detectedMicros.map(([key, val]) => {
                const m = (typeof MICROS_META !== 'undefined' ? MICROS_META : []).find(x => x.key === key);
                return React.createElement('span', { key, style: { fontSize: 11, background: 'rgba(255,255,255,.07)', borderRadius: 6, padding: '3px 8px', color: m ? m.color : 'var(--t2)' } },
                  `${m ? m.label : key} ${val}${m ? m.unit : ''}`
                );
              })
            )
          );
        })()
      ),
      React.createElement('div', { style: { display: 'flex', gap: 10 } },
        React.createElement('button', { className: 'btn ghost', onClick: reset }, 'Retake'),
        React.createElement('button', { className: 'btn', style: { flex: 1, justifyContent: 'center' },
          onClick: () => onResult({ name: r.name || 'Scanned Product', cals100: r.cals100||0, protein100: r.protein100||0, carbs100: r.carbs100||0, fat100: r.fat100||0, defaultGrams: g, barcode: null, micros: r.micros_per_serving || {} })
        }, mode === 'supp' ? '+ Add to Stack' : '+ Add to Log')
      )
    ));
  }

  // ============================================================
  // NutritionTab override — adds Scan Barcode, My Foods, smart search
  // ============================================================
  const MY_FOODS_KEY = 'fitlife_my_foods';
  const _getMyFoods = () => { try { return JSON.parse(localStorage.getItem(MY_FOODS_KEY) || '[]'); } catch(e) { return []; } };
  const _saveMyFoodsLS = (arr) => { try { localStorage.setItem(MY_FOODS_KEY, JSON.stringify(arr)); } catch(e) {} };

  const SUPPS_KEY = 'fitlife_supps';
  const _getSupps = () => { try { return JSON.parse(localStorage.getItem(SUPPS_KEY) || '[]'); } catch(e) { return []; } };
  const _saveSupps = (arr) => { try { localStorage.setItem(SUPPS_KEY, JSON.stringify(arr)); } catch(e) {} };

  // Micronutrient targets for 56yo male (DRI/RDA). Units: fiber=g, vitD=IU, vitK=mcg, omega3/mag/calcium/zinc/vitC/potassium=mg, b12=mcg
  const MICROS_META = [
    { key: 'fiber',     label: 'Fiber',       unit: 'g',   rda: 30,   color: '#fb923c' },
    { key: 'vitD',      label: 'Vitamin D',   unit: 'IU',  rda: 600,  color: '#fcd34d' },
    { key: 'vitK',      label: 'Vitamin K',   unit: 'mcg', rda: 120,  color: '#86efac' },
    { key: 'omega3',    label: 'Omega-3',     unit: 'mg',  rda: 1600, color: '#60a5fa' },
    { key: 'magnesium', label: 'Magnesium',   unit: 'mg',  rda: 420,  color: '#c4b5fd' },
    { key: 'calcium',   label: 'Calcium',     unit: 'mg',  rda: 1000, color: '#f9a8d4' },
    { key: 'zinc',      label: 'Zinc',        unit: 'mg',  rda: 11,   color: '#67e8f9' },
    { key: 'b12',       label: 'Vitamin B12', unit: 'mcg', rda: 2.4,  color: '#6ee7b7' },
    { key: 'vitC',      label: 'Vitamin C',   unit: 'mg',  rda: 90,   color: '#c8f135' },
    { key: 'potassium', label: 'Potassium',   unit: 'mg',  rda: 3400, color: '#fda4af' },
  ];

  const RECOMMENDED_SUPPS = [
    { id: 'rec_creatine', name: 'Creatine Monohydrate', isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 5,   defaultUnit: 'g',    timing: 'anytime',      micros: {},                                              note: 'Muscle preservation, strength, cognitive health. Most researched supplement. 5g/day.' },
    { id: 'rec_d3k2',     name: 'Vitamin D3 + K2',      isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 1,   defaultUnit: 'cap',  timing: 'morning',      micros: { vitD: 2000, vitK: 100 },                       note: 'Critical for testosterone, bone density, immune function. Most desk workers are deficient.' },
    { id: 'rec_omega3',   name: 'Omega-3 (EPA+DHA)',     isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 3,   defaultUnit: 'g',    timing: 'morning',      micros: { omega3: 2000 },                                note: '2–3g EPA+DHA daily. Anti-inflammatory, joint health, cardiovascular.' },
    { id: 'rec_mag',      name: 'Magnesium Glycinate',   isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 400, defaultUnit: 'mg',   timing: 'bedtime',      micros: { magnesium: 400 },                              note: '300–400mg before bed. Sleep quality, muscle recovery, glucose metabolism.' },
    { id: 'rec_collagen', name: 'Collagen Peptides',     isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 15,  defaultUnit: 'g',    timing: 'pre-workout',  micros: {},                                              note: 'Take with Vit C 30 min before training. Tendon & joint health — key for hip tightness.' },
    { id: 'rec_nad',      name: 'NAD+ (NMN/NR)',         isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 1,   defaultUnit: 'cap',  timing: 'morning',      micros: {},                                              note: 'Mitochondrial energy, cellular repair. Peter Attia longevity protocol.' },
    { id: 'rec_fiber',    name: 'Fiber Supplement',      isMacro: false, cals100: 0, protein100: 0, carbs100: 0, fat100: 0, defaultGrams: 1,   defaultUnit: 'srv',  timing: 'morning',      micros: { fiber: 5 },                                    note: 'Digestive health, satiety during fat loss. Aim 25–35g total fiber/day.' },
    { id: 'rec_whey',     name: 'Whey Protein',          isMacro: true,  cals100: 370, protein100: 80, carbs100: 8, fat100: 4, defaultGrams: 30, defaultUnit: 'g',  timing: 'post-workout', micros: {},                                              note: 'Safety net for hitting 175g/day protein. ~25g protein per 30g scoop.' },
  ];

  function NutritionTab({ nutrition, setNutrition }) {
    const today = new Date().toDateString();
    const tl = nutrition.find(n => n.date === today) || { date: today, cals: 0, protein: 0, fat: 0, carbs: 0, items: [] };
    const [view, setView] = React.useState('today');
    const [c, setC] = React.useState({ name: '', cals: '', protein: '', fat: '', carbs: '' });
    const [showScanner, setShowScanner] = React.useState(false);
    const [scanKey, setScanKey] = React.useState(0);
    const [showLabelScanner, setShowLabelScanner] = React.useState(false);
    const [labelScanMode, setLabelScanMode] = React.useState('food');

    // Supplements
    const [suppStack, setSuppStack] = React.useState(_getSupps);
    const [showSuppScanner, setShowSuppScanner] = React.useState(false);
    const [suppScanKey, setSuppScanKey] = React.useState(0);
    const [pendingSuppRaw, setPendingSuppRaw] = React.useState(null);
    const [suppConfig, setSuppConfig] = React.useState(null);
    const [showSuppManual, setShowSuppManual] = React.useState(false);
    const [suppManual, setSuppManual] = React.useState({ name: '', timing: 'anytime', isMacro: false, defaultGrams: '', defaultUnit: 'g' });

    // My Foods
    const [myFoods, setMyFoods] = React.useState(_getMyFoods);

    const saveToMyFoods = (raw) => {
      setMyFoods(prev => {
        const existing = raw.barcode ? prev.findIndex(f => f.barcode && f.barcode === raw.barcode) : -1;
        let next;
        if (existing >= 0) {
          next = prev.map((f, i) => i === existing ? { ...f, defaultGrams: raw.defaultGrams } : f);
        } else {
          next = [{ id: Date.now(), ...raw }, ...prev];
        }
        _saveMyFoodsLS(next);
        return next;
      });
    };

    const removeFromMyFoods = (id) => {
      setMyFoods(prev => {
        const next = prev.filter(f => f.id !== id);
        _saveMyFoodsLS(next);
        return next;
      });
    };

    const saveSuppStack = (arr) => { _saveSupps(arr); setSuppStack(arr); };

    const addToStack = (supp) => {
      if (suppStack.find(s => s.name.toLowerCase() === supp.name.toLowerCase())) return;
      saveSuppStack([...suppStack, { ...supp, id: supp.id || Date.now() }]);
    };

    const removeFromStack = (id) => {
      saveSuppStack(suppStack.filter(s => s.id !== id));
    };

    const toggleSupp = async (supp) => {
      const checked = !!(tl.supps && tl.supps[supp.id]);
      const newSupps = { ...(tl.supps || {}), [supp.id]: !checked };
      let u = { ...tl, supps: newSupps };
      // Macro supplement: add to Fuel totals when checking, not when unchecking
      if (supp.isMacro && !checked) {
        const g = supp.defaultGrams || 30;
        const scale = g / 100;
        u = {
          ...u,
          cals:    Math.round(u.cals    + (supp.cals100    || 0) * scale),
          protein: Math.round((u.protein + (supp.protein100 || 0) * scale) * 10) / 10,
          carbs:   Math.round((u.carbs   + (supp.carbs100   || 0) * scale) * 10) / 10,
          fat:     Math.round((u.fat     + (supp.fat100     || 0) * scale) * 10) / 10,
          items: [...(u.items || []), {
            name: `${supp.name} (${g}${supp.defaultUnit || 'g'})`,
            cals:    Math.round((supp.cals100    || 0) * scale),
            protein: Math.round((supp.protein100 || 0) * scale * 10) / 10,
            carbs:   Math.round((supp.carbs100   || 0) * scale * 10) / 10,
            fat:     Math.round((supp.fat100     || 0) * scale * 10) / 10,
          }],
        };
      }
      // Micronutrients: add on check, subtract on uncheck
      if (supp.micros && Object.keys(supp.micros).length > 0) {
        const cur = { ...(u.micros || {}) };
        Object.entries(supp.micros).forEach(([key, val]) => {
          if (val > 0) cur[key] = Math.max(0, (cur[key] || 0) + (checked ? -val : val));
        });
        u = { ...u, micros: cur };
      }
      const nn = [u, ...nutrition.filter(n => n.date !== today)];
      setNutrition(nn);
      await sset('nutrition', nn);
    };

    const add = async (food) => {
      // Merge micronutrients from food into daily totals
      let mergedMicros = { ...(tl.micros || {}) };
      if (food.micros) {
        Object.entries(food.micros).forEach(([key, val]) => {
          if (val > 0) mergedMicros[key] = +((( mergedMicros[key] || 0) + val).toFixed(2));
        });
      }
      const u = {
        ...tl,
        cals:    Math.round(tl.cals    + (+(food.cals    || 0))),
        protein: Math.round((tl.protein + (+(food.protein || 0))) * 10) / 10,
        fat:     Math.round((tl.fat     + (+(food.fat     || 0))) * 10) / 10,
        carbs:   Math.round((tl.carbs   + (+(food.carbs   || 0))) * 10) / 10,
        micros: mergedMicros,
        items: [...(tl.items || []), { name: food.name, cals: +(food.cals||0), protein: +(food.protein||0), carbs: +(food.carbs||0), fat: +(food.fat||0) }],
      };
      const nn = [u, ...nutrition.filter(n => n.date !== today)];
      setNutrition(nn);
      await sset('nutrition', nn);
    };

    const removeItem = async (idx) => {
      const item = (tl.items || [])[idx];
      const isObj = item && typeof item === 'object';
      const u = {
        ...tl,
        cals:    Math.max(0, Math.round(tl.cals    - (isObj ? item.cals    : 0))),
        protein: Math.max(0, Math.round((tl.protein - (isObj ? item.protein : 0)) * 10) / 10),
        fat:     Math.max(0, Math.round((tl.fat     - (isObj ? item.fat     : 0)) * 10) / 10),
        carbs:   Math.max(0, Math.round((tl.carbs   - (isObj ? item.carbs   : 0)) * 10) / 10),
        items: (tl.items || []).filter((_, i) => i !== idx),
      };
      const nn = [u, ...nutrition.filter(n => n.date !== today)];
      setNutrition(nn);
      await sset('nutrition', nn);
    };

    const addMyFood = (f) => {
      const g = f.defaultGrams || 100;
      const scale = g / 100;
      add({
        name: `${f.name} (${g}g)`,
        cals: Math.round(f.cals100 * scale),
        protein: Math.round(f.protein100 * scale * 10) / 10,
        carbs: Math.round(f.carbs100 * scale * 10) / 10,
        fat: Math.round(f.fat100 * scale * 10) / 10,
      });
    };

    // Smart search
    const [suggestions, setSuggestions] = React.useState([]);
    const [searching, setSearching] = React.useState(false);
    const [selectedFood, setSelectedFood] = React.useState(null);
    const [customAmt, setCustomAmt] = React.useState('100');
    const [customUnit, setCustomUnit] = React.useState('g');
    const [servingMeasures, setServingMeasures] = React.useState(null); // null=not loaded, [{text,gramWeight}]
    const [selectedMeasureIdx, setSelectedMeasureIdx] = React.useState(0);
    const [servingQty, setServingQty] = React.useState('1');
    const [loadingMeasures, setLoadingMeasures] = React.useState(false);
    const searchTimerRef = React.useRef(null);

    const unitFactors = { g: 1, oz: 28.35, lb: 453.59, cup: 237, 'fl oz': 29.57 };

    const searchFoods = async (query) => {
      if (!query || query.length < 2) { setSuggestions([]); return; }
      setSearching(true);
      try {
        // Single USDA call — Foundation+SR Legacy for whole foods, Branded for packaged.
        // Avoids OFN which returns anything containing the word (apple → croissants, strudels).
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 6000);
        const res = await fetch(
          `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&api_key=DEMO_KEY&dataType=Foundation,SR%20Legacy,Branded&pageSize=10`,
          { signal: ctrl.signal }
        ).finally(() => clearTimeout(t));
        if (!res.ok) throw new Error();
        const data = await res.json();
        const items = (data.foods || []).map(f => {
          const nmap = {};
          (f.foodNutrients || []).forEach(n => { nmap[n.nutrientId] = n.value; });
          const parts = (f.description || '').split(',');
          const name = parts[0].trim().replace(/\b\w/g, l => l.toUpperCase()) +
            (parts[1] ? ` (${parts[1].trim().toLowerCase()})` : '');
          // Energy: try 1008 (kcal), 2047/2048 (Atwater variants), 1062 (kJ÷4.184)
          const kcal = nmap[1008] || nmap[2047] || nmap[2048] || Math.round((nmap[1062] || 0) / 4.184) || 0;
          return {
            name,
            cals100: Math.round(kcal),
            protein100: +((nmap[1003] || 0).toFixed(1)),
            carbs100:   +((nmap[1005] || 0).toFixed(1)),
            fat100:     +((nmap[1004] || 0).toFixed(1)),
            fdcId: f.fdcId,
            servingSize: f.servingSize || null,
            servingSizeUnit: (f.servingSizeUnit || 'g').toLowerCase(),
            _type: f.dataType,
          };
        }).filter(f => f.cals100 > 0 || f.protein100 > 0);
        // Sort: Foundation first, then SR Legacy, then Branded Food (USDA returns "Branded Food" not "Branded")
        const rank = { Foundation: 0, 'SR Legacy': 1, 'Branded Food': 2, Branded: 2 };
        items.sort((a, b) => (rank[a._type] ?? 3) - (rank[b._type] ?? 3));
        setSuggestions(items.slice(0, 5).map(({ name, cals100, protein100, carbs100, fat100, fdcId, servingSize, servingSizeUnit }) => ({ name, cals100, protein100, carbs100, fat100, fdcId, servingSize, servingSizeUnit })));
      } catch(e) {
        setSuggestions([]);
      } finally {
        setSearching(false);
      }
    };

    const handleNameChange = (val) => {
      setC(p => ({ ...p, name: val }));
      setSelectedFood(null);
      setServingMeasures(null);
      clearTimeout(searchTimerRef.current);
      searchTimerRef.current = setTimeout(() => searchFoods(val), 500);
    };

    const selectSuggestion = async (s) => {
      setC(p => ({ ...p, name: s.name, cals: '', protein: '', carbs: '', fat: '' }));
      setSelectedFood(s);
      setSuggestions([]);
      setServingQty('1');
      setSelectedMeasureIdx(0);
      setServingMeasures(null);
      if (!s.fdcId) return;
      setLoadingMeasures(true);
      try {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 5000);
        const res = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${s.fdcId}?api_key=DEMO_KEY`, { signal: ctrl.signal }).finally(() => clearTimeout(t));
        if (res.ok) {
          const data = await res.json();
          let measures = (data.foodMeasures || [])
            .filter(m => m.gramWeight > 0)
            .map(m => ({ text: m.disseminationText, gramWeight: m.gramWeight }));
          if (measures.length === 0 && s.servingSize && s.servingSizeUnit === 'g') {
            measures = [{ text: `1 serving (${s.servingSize}g)`, gramWeight: s.servingSize }];
          }
          measures.push({ text: '100g', gramWeight: 100 });
          setServingMeasures(measures);
          setSelectedMeasureIdx(0);
        }
      } catch(e) {
        setServingMeasures([{ text: '100g', gramWeight: 100 }]);
      } finally {
        setLoadingMeasures(false);
      }
    };

    const getPreview = () => {
      if (!selectedFood) return null;
      let grams;
      if (servingMeasures && servingMeasures.length > 0) {
        grams = servingMeasures[selectedMeasureIdx].gramWeight * (parseFloat(servingQty) || 1);
      } else {
        grams = parseFloat(customAmt) * (unitFactors[customUnit] || 1);
      }
      if (!grams || isNaN(grams)) return null;
      const scale = grams / 100;
      return {
        cals: Math.round(selectedFood.cals100 * scale),
        protein: Math.round(selectedFood.protein100 * scale * 10) / 10,
        carbs: Math.round(selectedFood.carbs100 * scale * 10) / 10,
        fat: Math.round(selectedFood.fat100 * scale * 10) / 10,
        grams: Math.round(grams),
      };
    };

    const addC = () => {
      if (!selectedFood) return;
      const preview = getPreview();
      if (!preview) return;
      let label;
      if (servingMeasures && servingMeasures.length > 0) {
        const qty = parseFloat(servingQty) || 1;
        label = qty === 1 ? servingMeasures[selectedMeasureIdx].text : `${qty}× ${servingMeasures[selectedMeasureIdx].text}`;
      } else {
        label = `${customAmt}${customUnit}`;
      }
      add({ name: `${c.name} (${label})`, cals: preview.cals, protein: preview.protein, carbs: preview.carbs, fat: preview.fat });
      setC({ name: '', cals: '', protein: '', fat: '', carbs: '' });
      setSelectedFood(null);
      setServingMeasures(null);
      setServingQty('1');
      setSelectedMeasureIdx(0);
      setCustomAmt('100');
      setCustomUnit('g');
      setSuggestions([]);
    };

    const left = USER.targetCals - tl.cals;

    return React.createElement('div', null,
      // ── Barcode scanner + label scanner overlays ──────────────
      showLabelScanner && React.createElement(LabelScanner, {
        mode: labelScanMode,
        onClose: () => setShowLabelScanner(false),
        onResult: (raw) => {
          setShowLabelScanner(false);
          if (labelScanMode === 'supp') {
            setSuppConfig({ name: raw.name, isMacro: raw.cals100 > 10, timing: 'anytime', cals100: raw.cals100, protein100: raw.protein100, carbs100: raw.carbs100, fat100: raw.fat100, defaultGrams: raw.defaultGrams, defaultUnit: 'g', micros: raw.micros || {} });
            setView('supps');
          } else {
            saveToMyFoods(raw);
            add({ name: `${raw.name} (${raw.defaultGrams}g)`, cals: Math.round(raw.cals100 * raw.defaultGrams / 100), protein: Math.round(raw.protein100 * raw.defaultGrams / 100 * 10) / 10, carbs: Math.round(raw.carbs100 * raw.defaultGrams / 100 * 10) / 10, fat: Math.round(raw.fat100 * raw.defaultGrams / 100 * 10) / 10 });
          }
        },
      }),
      showScanner && React.createElement(BarcodeScanner, {
        key: scanKey,
        onAdd: food => add(food),
        onClose: () => setShowScanner(false),
        onRescan: () => setScanKey(k => k + 1),
        onSave: raw => saveToMyFoods(raw),
        onScanLabel: () => { setLabelScanMode('food'); setShowLabelScanner(true); },
      }),
      showSuppScanner && React.createElement(BarcodeScanner, {
        key: 'supp-' + suppScanKey,
        addLabel: '+ Add to Stack',
        onSave: raw => setPendingSuppRaw(raw),
        onScanLabel: () => { setLabelScanMode('supp'); setShowLabelScanner(true); },
        onAdd: (food) => {
          const raw = pendingSuppRaw;
          setShowSuppScanner(false);
          setPendingSuppRaw(null);
          setSuppConfig({
            name: raw ? raw.name : food.name.replace(/ \(\d+g\)$/, ''),
            isMacro: food.cals > 10,
            timing: 'anytime',
            cals100: raw ? raw.cals100 : 0,
            protein100: raw ? raw.protein100 : 0,
            carbs100: raw ? raw.carbs100 : 0,
            fat100: raw ? raw.fat100 : 0,
            defaultGrams: raw ? raw.defaultGrams : 100,
            defaultUnit: 'g',
          });
          setView('supps');
        },
        onClose: () => {
          const hadRaw = !!pendingSuppRaw;
          setShowSuppScanner(false);
          setPendingSuppRaw(null);
          if (!hadRaw) { setShowSuppManual(true); setView('supps'); }
        },
        onRescan: () => setSuppScanKey(k => k + 1),
      }),

      // ── Page header ──────────────────────────────────────────
      React.createElement('div', { className: 'ph' },
        React.createElement('div', { className: 'ph-title' }, 'FUEL'),
        React.createElement('div', { className: 'ph-sub' }, `Flexible tracking · ${USER.targetCals} cal target`)
      ),

      // ── Sub-tabs ─────────────────────────────────────────────
      React.createElement('div', { className: 'tabs' },
        ...['today','log','supps','targets'].map((v, i) =>
          React.createElement('div', { key: v, className: `tab ${view === v ? 'on' : ''}`, onClick: () => setView(v) },
            ['Today','Log Food','Supps','Targets'][i]
          )
        )
      ),

      // ── Today view ───────────────────────────────────────────
      view === 'today' && React.createElement(React.Fragment, null,
        React.createElement('div', { className: 'card', style: { marginTop: 10 } },
          React.createElement('div', { className: 'clbl' }, "Today's Totals"),
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-around', textAlign: 'center', marginBottom: 16 } },
            ...[
              { v: tl.cals, l: 'Eaten', c: left < 0 ? 'var(--red)' : 'var(--lime)' },
              { v: Math.max(left, 0), l: 'Left', c: 'var(--t2)' },
              { v: `${tl.protein}g`, l: 'Protein', c: 'var(--blue)' }
            ].map((s, i) => React.createElement('div', { key: i },
              React.createElement('div', { style: { fontFamily: 'var(--fd)', fontSize: 36, color: s.c, lineHeight: 1 } }, s.v),
              React.createElement('div', { style: { fontSize: 10, color: 'var(--t3)', marginTop: 3, textTransform: 'uppercase' } }, s.l)
            ))
          ),
          ...[
            { name: 'Protein', val: tl.protein, max: USER.protein, bg: 'var(--blue)' },
            { name: 'Carbs',   val: tl.carbs,   max: USER.carbs,   bg: 'var(--purple)' },
            { name: 'Fat',     val: tl.fat,      max: USER.fat,     bg: 'var(--amber)' },
          ].map(m => React.createElement('div', { key: m.name, className: 'mr' },
            React.createElement('span', { className: 'mn' }, m.name),
            React.createElement('div', { className: 'mb' },
              React.createElement('div', { className: 'mf', style: { width: `${Math.min(m.val / m.max * 100, 100)}%`, background: m.bg } })
            ),
            React.createElement('span', { className: 'mv' }, `${m.val}/${m.max}g`)
          ))
        ),
        (tl.items || []).length > 0 && React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'clbl' }, 'Logged Today'),
          ...(tl.items || []).map((item, i) => {
            const name = typeof item === 'object' ? item.name : item;
            const cals = typeof item === 'object' ? item.cals : null;
            return React.createElement('div', { key: i, style: { display: 'flex', alignItems: 'center', padding: '7px 0', borderBottom: '1px solid var(--border)' } },
              React.createElement('span', { style: { flex: 1, fontSize: 13, color: 'var(--t2)' } }, name),
              cals != null && React.createElement('span', { style: { fontSize: 11, color: 'var(--t3)', marginRight: 10 } }, `${cals} cal`),
              React.createElement('span', {
                style: { fontSize: 20, color: 'var(--t3)', cursor: 'pointer', padding: '0 2px', lineHeight: 1 },
                onClick: () => removeItem(i)
              }, '×')
            );
          })
        ),
        React.createElement('div', { className: 'co lime', style: { marginTop: 10 } },
          React.createElement('strong', { style: { color: 'var(--lime)' } }, '💡 Protein First'),
          React.createElement('br'),
          `At 56, ${USER.protein}g protein daily preserves muscle during fat loss. Aim 40–50g per meal, 3–4 meals.`
        )
      ),

      // ── Log Food view ────────────────────────────────────────
      view === 'log' && React.createElement(React.Fragment, null,
        // Barcode Scanner card
        React.createElement('div', { className: 'card', style: { marginTop: 10 } },
          React.createElement('div', { className: 'clbl' }, 'Barcode Scanner'),
          React.createElement('button', {
            className: 'btn full',
            style: { fontSize: 15, justifyContent: 'center', gap: 10 },
            onClick: () => setShowScanner(true)
          },
            React.createElement('span', null, '📷'),
            ' Scan Food Barcode'
          ),
          React.createElement('div', { style: { fontSize: 11, color: 'var(--t3)', textAlign: 'center', marginTop: 8, lineHeight: 1.5 } },
            'Tries Open Food Facts then USDA — covers most packaged foods'
          ),
          React.createElement('button', {
            className: 'btn ghost',
            style: { width: '100%', justifyContent: 'center', gap: 8, marginTop: 8, fontSize: 14, borderColor: 'var(--blue)', color: 'var(--blue)' },
            onClick: () => { setLabelScanMode('food'); setShowLabelScanner(true); }
          }, '📸 Scan Label')
        ),
        // Quick Add card — My Foods + presets combined, sorted alphabetically
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'clbl' }, 'Quick Add'),
          React.createElement('div', { style: { maxHeight: 220, overflowY: 'auto' } },
            ...[
              ...myFoods.map(f => ({ ...f, _type: 'my', _cal: Math.round(f.cals100 * f.defaultGrams / 100) })),
              ...FOODS.map(f => ({ ...f, _type: 'preset', _cal: f.cals }))
            ]
            .sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()))
            .map((f, i, arr) => React.createElement('div', {
              key: `${f._type}-${f.name}-${i}`,
              style: { display: 'flex', alignItems: 'center', padding: '8px 0', borderBottom: i < arr.length - 1 ? '1px solid var(--border)' : 'none' }
            },
              React.createElement('span', {
                style: { flex: 1, fontSize: 13, color: 'var(--t2)', cursor: 'pointer' },
                onClick: () => f._type === 'my' ? addMyFood(f) : add(f)
              },
                '+ ', f.name,
                React.createElement('span', { style: { color: 'var(--t3)', fontSize: 11, marginLeft: 6 } }, `${f._cal} cal`)
              ),
              f._type === 'my' && React.createElement('span', {
                style: { fontSize: 18, color: 'var(--t3)', cursor: 'pointer', padding: '0 6px', lineHeight: 1 },
                onClick: () => removeFromMyFoods(f.id)
              }, '×')
            ))
          )
        ),
        // Custom Entry card with smart search
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'clbl' }, 'Custom Entry'),
          React.createElement('div', { className: 'ig', style: { position: 'relative' } },
            React.createElement('label', { className: 'ilbl' }, 'Food Name'),
            React.createElement('input', { className: 'inp', type: 'search', placeholder: 'e.g. Coffee, Chicken breast', value: c.name, onChange: e => handleNameChange(e.target.value), autoComplete: 'off', autoCorrect: 'off', autoCapitalize: 'none', spellCheck: false }),
            searching && React.createElement('div', { style: { fontSize: 11, color: 'var(--t3)', marginTop: 4 } }, 'Searching...'),
            suggestions.length > 0 && React.createElement('div', {
              style: { position: 'absolute', top: '100%', left: 0, right: 0, background: 'var(--surface)', border: '1px solid var(--border)', borderRadius: 8, zIndex: 100, overflow: 'hidden', marginTop: 2 }
            },
              ...suggestions.map((s, i) => React.createElement('div', {
                key: i,
                style: { padding: '9px 12px', fontSize: 13, borderBottom: i < suggestions.length - 1 ? '1px solid var(--border)' : 'none', cursor: 'pointer', color: 'var(--text)' },
                onClick: () => selectSuggestion(s)
              },
                React.createElement('div', null, s.name),
                React.createElement('div', { style: { fontSize: 11, color: 'var(--t3)', marginTop: 2 } },
                  `${s.cals100} kcal · P ${s.protein100}g · C ${s.carbs100}g · F ${s.fat100}g per 100g`
                )
              ))
            )
          ),
          selectedFood
            ? React.createElement(React.Fragment, null,
                loadingMeasures
                  ? React.createElement('div', { style: { fontSize: 12, color: 'var(--t3)', padding: '10px 4px' } }, 'Loading serving sizes…')
                  : servingMeasures
                    ? React.createElement('div', { style: { display: 'flex', gap: 8, marginTop: 8 } },
                        React.createElement('div', { className: 'ig', style: { flex: 2 } },
                          React.createElement('label', { className: 'ilbl' }, 'Serving'),
                          React.createElement('select', { className: 'inp', value: selectedMeasureIdx, onChange: e => setSelectedMeasureIdx(+e.target.value), style: { appearance: 'auto' } },
                            ...servingMeasures.map((m, i) => React.createElement('option', { key: i, value: i }, m.text))
                          )
                        ),
                        React.createElement('div', { className: 'ig', style: { flex: 1 } },
                          React.createElement('label', { className: 'ilbl' }, 'Qty'),
                          React.createElement('input', { className: 'inp', type: 'number', inputMode: 'decimal', placeholder: '1', value: servingQty, onChange: e => setServingQty(e.target.value) })
                        )
                      )
                    : React.createElement('div', { style: { display: 'flex', gap: 8, marginTop: 8 } },
                        React.createElement('div', { className: 'ig', style: { flex: 1 } },
                          React.createElement('label', { className: 'ilbl' }, 'Amount'),
                          React.createElement('input', { className: 'inp', type: 'number', inputMode: 'decimal', placeholder: '100', value: customAmt, onChange: e => setCustomAmt(e.target.value) })
                        ),
                        React.createElement('div', { className: 'ig', style: { flex: 1 } },
                          React.createElement('label', { className: 'ilbl' }, 'Unit'),
                          React.createElement('select', { className: 'inp', value: customUnit, onChange: e => setCustomUnit(e.target.value), style: { appearance: 'auto' } },
                            ...Object.keys(unitFactors).map(u => React.createElement('option', { key: u, value: u }, u))
                          )
                        )
                      ),
                (() => {
                  const p = getPreview();
                  return p ? React.createElement('div', {
                    style: { background: 'var(--surface2)', borderRadius: 8, padding: '8px 12px', marginTop: 6, fontSize: 12, color: 'var(--t2)', display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: 4 }
                  },
                    React.createElement('span', null, `${p.grams}g`),
                    React.createElement('span', { style: { color: 'var(--lime)' } }, `${p.cals} kcal`),
                    React.createElement('span', null, `P ${p.protein}g`),
                    React.createElement('span', null, `C ${p.carbs}g`),
                    React.createElement('span', null, `F ${p.fat}g`)
                  ) : null;
                })()
              )
            : React.createElement('div', { style: { fontSize: 12, color: 'var(--t3)', padding: '10px 4px' } },
                'Type a food name above to search, or use Quick Add / 📸 Scan Label below.'
              ),
          React.createElement('button', { className: 'btn full', style: { marginTop: 10 }, onClick: addC }, 'Add Food')
        )
      ),

      // ── Supps view ───────────────────────────────────────────
      view === 'supps' && React.createElement(React.Fragment, null,
        // Config panel — shown after scan or manual entry
        (suppConfig || showSuppManual) && React.createElement('div', {
          className: 'card', style: { marginTop: 10, border: '1px solid var(--lime)', borderRadius: 14 }
        },
          React.createElement('div', { className: 'clbl' }, suppConfig ? 'Confirm Supplement' : 'Add Supplement'),
          React.createElement('div', { className: 'ig' },
            React.createElement('label', { className: 'ilbl' }, 'Name'),
            React.createElement('input', { className: 'inp', placeholder: 'e.g. Creatine Monohydrate',
              value: suppConfig ? suppConfig.name : suppManual.name,
              onChange: e => suppConfig ? setSuppConfig(p => ({...p, name: e.target.value})) : setSuppManual(p => ({...p, name: e.target.value}))
            })
          ),
          React.createElement('div', { style: { display: 'flex', gap: 8 } },
            React.createElement('div', { className: 'ig', style: { flex: 2 } },
              React.createElement('label', { className: 'ilbl' }, 'Timing'),
              React.createElement('select', { className: 'inp', style: { appearance: 'auto' },
                value: suppConfig ? suppConfig.timing : suppManual.timing,
                onChange: e => suppConfig ? setSuppConfig(p => ({...p, timing: e.target.value})) : setSuppManual(p => ({...p, timing: e.target.value}))
              },
                ...['morning','pre-workout','post-workout','bedtime','anytime'].map(t =>
                  React.createElement('option', { key: t, value: t }, t.charAt(0).toUpperCase() + t.slice(1))
                )
              )
            ),
            React.createElement('div', { className: 'ig', style: { flex: 1 } },
              React.createElement('label', { className: 'ilbl' }, 'Amount'),
              React.createElement('input', { className: 'inp', type: 'number', inputMode: 'decimal', placeholder: '5',
                value: suppConfig ? suppConfig.defaultGrams : suppManual.defaultGrams,
                onChange: e => suppConfig ? setSuppConfig(p => ({...p, defaultGrams: e.target.value})) : setSuppManual(p => ({...p, defaultGrams: e.target.value}))
              })
            ),
            React.createElement('div', { className: 'ig', style: { flex: 1 } },
              React.createElement('label', { className: 'ilbl' }, 'Unit'),
              React.createElement('select', { className: 'inp', style: { appearance: 'auto' },
                value: suppConfig ? suppConfig.defaultUnit : suppManual.defaultUnit,
                onChange: e => suppConfig ? setSuppConfig(p => ({...p, defaultUnit: e.target.value})) : setSuppManual(p => ({...p, defaultUnit: e.target.value}))
              },
                ...['g','mg','ml','cap','srv','tsp','tbsp'].map(u => React.createElement('option', { key: u, value: u }, u))
              )
            )
          ),
          React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', marginTop: 4 } },
            React.createElement('input', { type: 'checkbox',
              checked: suppConfig ? suppConfig.isMacro : suppManual.isMacro,
              onChange: e => suppConfig ? setSuppConfig(p => ({...p, isMacro: e.target.checked})) : setSuppManual(p => ({...p, isMacro: e.target.checked}))
            }),
            React.createElement('span', { style: { fontSize: 13, color: 'var(--t2)' } }, 'Counts toward daily calorie & macro totals')
          ),
          React.createElement('div', { style: { display: 'flex', gap: 8, marginTop: 10 } },
            React.createElement('button', { className: 'btn ghost',
              onClick: () => { setSuppConfig(null); setShowSuppManual(false); setSuppManual({ name: '', timing: 'anytime', isMacro: false, defaultGrams: '', defaultUnit: 'g' }); }
            }, 'Cancel'),
            React.createElement('button', { className: 'btn', style: { flex: 1, justifyContent: 'center' },
              onClick: () => {
                const src = suppConfig || suppManual;
                if (!src.name) return;
                addToStack({ ...src, defaultGrams: parseFloat(src.defaultGrams) || 5 });
                setSuppConfig(null);
                setShowSuppManual(false);
                setSuppManual({ name: '', timing: 'anytime', isMacro: false, defaultGrams: '', defaultUnit: 'g' });
              }
            }, 'Save to Stack')
          )
        ),

        // My Stack card
        React.createElement('div', { className: 'card', style: { marginTop: 10 } },
          React.createElement('div', { className: 'clbl' }, 'My Stack'),
          suppStack.length === 0
            ? React.createElement('div', { style: { fontSize: 13, color: 'var(--t3)', textAlign: 'center', padding: '12px 0' } },
                'Add supplements from Recommended below or scan a barcode'
              )
            : React.createElement(React.Fragment, null,
                ...suppStack.map(s => {
                  const checked = !!(tl.supps && tl.supps[s.id]);
                  const timingColors = { morning: 'var(--amber)', 'pre-workout': 'var(--lime)', 'post-workout': 'var(--blue)', bedtime: 'var(--purple)', anytime: 'var(--t3)' };
                  return React.createElement('div', { key: s.id,
                    style: { display: 'flex', alignItems: 'flex-start', padding: '10px 0', borderBottom: '1px solid var(--border)', gap: 10 }
                  },
                    // Checkbox
                    React.createElement('div', {
                      style: { width: 22, height: 22, borderRadius: 6, border: `2px solid ${checked ? 'var(--lime)' : 'var(--border)'}`, background: checked ? 'var(--lime)' : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', flexShrink: 0, marginTop: 1 },
                      onClick: () => toggleSupp(s)
                    }, checked ? React.createElement('span', { style: { color: '#000', fontSize: 12, fontWeight: 'bold', lineHeight: 1 } }, '✓') : null),
                    // Info
                    React.createElement('div', { style: { flex: 1 } },
                      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6, flexWrap: 'wrap' } },
                        React.createElement('span', { style: { fontSize: 14, color: checked ? 'var(--t2)' : 'var(--text)', textDecoration: checked ? 'line-through' : 'none' } }, s.name),
                        s.isMacro && React.createElement('span', { style: { fontSize: 10, color: 'var(--lime)', border: '1px solid var(--lime)', borderRadius: 4, padding: '1px 5px' } }, 'FUEL')
                      ),
                      React.createElement('div', { style: { display: 'flex', gap: 8, marginTop: 3 } },
                        React.createElement('span', { style: { fontSize: 11, color: timingColors[s.timing] || 'var(--t3)' } }, s.timing),
                        s.defaultGrams && React.createElement('span', { style: { fontSize: 11, color: 'var(--t3)' } }, `${s.defaultGrams}${s.defaultUnit || 'g'}`)
                      )
                    ),
                    // Delete
                    React.createElement('span', { style: { fontSize: 18, color: 'var(--t3)', cursor: 'pointer', padding: '0 2px', lineHeight: 1 }, onClick: () => removeFromStack(s.id) }, '×')
                  );
                })
              )
        ),

        // Add supplement card
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'clbl' }, 'Add Supplement'),
          React.createElement('div', { style: { display: 'flex', gap: 10 } },
            React.createElement('button', { className: 'btn ghost', style: { flex: 1, justifyContent: 'center', fontSize: 13 },
              onClick: () => { setPendingSuppRaw(null); setShowSuppScanner(true); }
            }, '📷 Scan Barcode'),
            React.createElement('button', { className: 'btn ghost', style: { flex: 1, justifyContent: 'center', fontSize: 13 },
              onClick: () => setShowSuppManual(true)
            }, '+ Enter Manually')
          ),
          React.createElement('button', {
            className: 'btn ghost',
            style: { width: '100%', justifyContent: 'center', fontSize: 13, marginTop: 8, borderColor: 'var(--blue)', color: 'var(--blue)' },
            onClick: () => { setLabelScanMode('supp'); setShowLabelScanner(true); }
          }, '📸 Scan Label')
        ),

        // Recommended card
        (() => {
          const stackNames = suppStack.map(s => s.name.toLowerCase());
          const remaining = RECOMMENDED_SUPPS.filter(r => !stackNames.includes(r.name.toLowerCase()));
          return remaining.length > 0 ? React.createElement('div', { className: 'card' },
            React.createElement('div', { className: 'clbl' }, 'Recommended for 56yo Male'),
            ...remaining.map(r => React.createElement('div', { key: r.id,
              style: { padding: '10px 0', borderBottom: '1px solid var(--border)' }
            },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 4 } },
                React.createElement('span', { style: { fontSize: 14, color: 'var(--text)', fontWeight: 500 } }, r.name),
                React.createElement('button', { className: 'btn ghost', style: { padding: '4px 10px', fontSize: 12 }, onClick: () => addToStack(r) }, '+ Add')
              ),
              React.createElement('div', { style: { fontSize: 12, color: 'var(--t3)', lineHeight: 1.55 } }, r.note)
            ))
          ) : null;
        })(),

        // ── Micronutrients card ───────────────────────────────────
        React.createElement('div', { className: 'card', style: { marginTop: 10 } },
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
            React.createElement('div', { className: 'clbl', style: { margin: 0 } }, 'Micronutrients'),
            React.createElement('div', { style: { fontSize: 10, color: 'var(--t3)', textTransform: 'uppercase' } }, 'from supps + food')
          ),
          ...MICROS_META.map(m => {
            const val = (tl.micros || {})[m.key] || 0;
            const pct = Math.min(val / m.rda * 100, 100);
            const dispVal = m.unit === 'g' ? val.toFixed(1) : m.unit === 'mcg' && m.rda < 10 ? val.toFixed(2) : Math.round(val);
            const dispRda = m.unit === 'g' ? m.rda.toFixed(0) : m.rda;
            return React.createElement('div', { key: m.key, className: 'mr', style: { marginBottom: 6 } },
              React.createElement('span', { className: 'mn', style: { color: pct >= 100 ? m.color : 'var(--t2)' } }, m.label),
              React.createElement('div', { className: 'mb' },
                React.createElement('div', { className: 'mf', style: { width: `${pct}%`, background: m.color, opacity: pct >= 100 ? 1 : 0.75 } })
              ),
              React.createElement('span', { className: 'mv', style: { fontSize: 11 } }, `${dispVal}/${dispRda}${m.unit}`)
            );
          })
        )
      ),

      // ── Targets view ─────────────────────────────────────────
      view === 'targets' && React.createElement(React.Fragment, null,
        React.createElement('div', { className: 'co lime', style: { marginTop: 10 } },
          React.createElement('strong', { style: { color: 'var(--lime)' } }, 'Calculated for You'),
          React.createElement('br'),
          `56yo male · 5'10" · 198 lb · lightly active · fat loss`
        ),
        React.createElement('div', { className: 'sg' },
          ...[
            { v: USER.tdee,       u: 'cal',   l: 'TDEE' },
            { v: USER.targetCals, u: 'cal',   l: 'Daily Target', c: 'var(--lime)' },
            { v: USER.protein,    u: 'g',     l: 'Protein',      c: 'var(--blue)' },
            { v: USER.carbs,      u: 'g',     l: 'Carbs',        c: 'var(--purple)' },
            { v: USER.fat,        u: 'g',     l: 'Fat',          c: 'var(--amber)' },
            { v: '~0.5',          u: 'lb/wk', l: 'Expected Loss' },
          ].map((s, i) => React.createElement('div', { key: i, className: 'sc', style: { cursor: 'default' } },
            React.createElement('div', { className: 'sv', style: { color: s.c || 'var(--text)' } },
              s.v, React.createElement('span', { className: 'su' }, s.u)
            ),
            React.createElement('div', { className: 'sl' }, s.l)
          ))
        ),
        React.createElement('div', { className: 'co blue', style: { marginTop: 4 } },
          React.createElement('strong', { style: { color: 'var(--blue)' } }, 'Flexible Tracking'),
          React.createElement('br'),
          '±10% of targets most days. Consistency over weeks beats single-day perfection.'
        )
      ),

      React.createElement('div', { className: 'gap' })
    );
  }
  </script>

  <script>
  // ============================================================
  // Security fix — CoachTab override
  // Adds localStorage API key management + correct Anthropic headers
  // Original CoachTab was missing: x-api-key, anthropic-version,
  // and anthropic-dangerous-direct-browser-access (required for browser CORS)
  // ============================================================

  const _COACH_KEY = 'fitlife_anthropic_key';
  const _getKey = () => { try { return localStorage.getItem(_COACH_KEY) || ''; } catch(e) { return ''; } };
  const _saveKey = (k) => { try { localStorage.setItem(_COACH_KEY, k.trim()); } catch(e) {} };

  function CoachTab({ history, weights }) {
    const [msgs, setMsgs] = React.useState([{
      role: 'assistant',
      text: "Hey! I'm your AI fitness coach. I've read your full exercise library and know your complete profile — 56yo male, desk worker, tight hips, solo training, home gym. I also track your workout history and current weights. What can I help with?"
    }]);
    const [input, setInput] = React.useState('');
    const [loading, setLoading] = React.useState(false);
    const [apiKey, setApiKey] = React.useState(_getKey);
    const [keyDraft, setKeyDraft] = React.useState('');
    const [editingKey, setEditingKey] = React.useState(false);

    const SUGG = [
      "How do I progress dead hangs to pull-ups?",
      "Best hip mobility routine for desk workers?",
      "Should I increase my KB swing weight?",
      "How do box jumps fit into my program?",
      "What's the science behind Norwegian 4x4?"
    ];

    const saveKey = () => {
      const k = keyDraft.trim();
      if (!k) return;
      _saveKey(k);
      setApiKey(k);
      setKeyDraft('');
      setEditingKey(false);
    };

    const send = async (msg) => {
      const txt = msg || input.trim();
      if (!txt || loading || !apiKey) return;
      setInput('');
      setMsgs(m => [...m, { role: 'user', text: txt }]);
      setLoading(true);
      const recent = history.filter(h => h.type === 'strength').slice(0, 4).map(s => ({
        date: s.date, workout: s.workout,
        fails: s.sets ? Object.values(s.sets).flat().filter(x => x.status === 'fail').length : 0,
        dones: s.sets ? Object.values(s.sets).flat().filter(x => x.status === 'done').length : 0,
      }));
      try {
        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            system: `You are a personal fitness and nutrition AI coach. Be specific, evidence-based, and encouraging.

USER PROFILE:
- 56yo male, 5'10", 198 lbs, intermediate lifter, desk worker (sits all day)
- Goal: fat loss + muscle preservation. Targets: ${USER.targetCals} cal, ${USER.protein}g protein, ${USER.carbs}g carbs, ${USER.fat}g fat
- Equipment: barbell + bench (solo — RPE 7 max), dumbbells, kettlebells, pull-up bar, elliptical, punching bag
- Known issues: shoulder (avoid heavy overhead), tight hips and hamstrings (can't touch toes), lower back sensitivity
- Interests: kettlebell training, ATG/knee-over-toe, Peter Attia longevity, Huberman Lab, Norwegian 4x4, BJJ/martial arts, VO₂ max

PROGRAM:
- A/B full body strength 3x/week (main lifts consistent + rotating accessories)
- 5 cardio protocols: Norwegian 4×4, Heavy Bag HIIT, KB Complex, Huberman Assault Bike, Japanese Interval Walk
- Mobility: Limber 11 pre-workout, morning CARs, hip mobility priority, BJJ shoulder stretch
- Progression: confirm before applying. 2 fails = 10% deweight. Deload every 4 weeks or performance-triggered.
- Cardio HR zone: ${HR_LOW}–${HR_HIGH} bpm (max HR ${MAX_HR})

RECENT SESSIONS: ${JSON.stringify(recent)}
WORKING WEIGHTS: ${JSON.stringify(weights)}

Keep responses under 200 words. Prioritize joint health, longevity, and sustainable progress for a 56yo solo trainer.`,
            messages: [...msgs.map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.text })), { role: 'user', content: txt }]
          })
        });
        const data = await res.json();
        if (data.error) {
          const isAuth = data.error.type === 'authentication_error';
          setMsgs(m => [...m, { role: 'assistant', text: isAuth ? '⚠️ Invalid API key. Tap 🔑 to update it.' : `Error: ${data.error.message}` }]);
        } else {
          setMsgs(m => [...m, { role: 'assistant', text: data.content?.map(c => c.text).join('') || "Couldn't connect." }]);
        }
      } catch(e) {
        setMsgs(m => [...m, { role: 'assistant', text: 'Connection error. Please try again.' }]);
      }
      setLoading(false);
    };

    // ── API key setup screen ──────────────────────────────────
    if (!apiKey || editingKey) {
      return React.createElement('div', null,
        React.createElement('div', { className: 'ph' },
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
            React.createElement('div', null,
              React.createElement('div', { className: 'ph-title' }, 'COACH'),
              React.createElement('div', { className: 'ph-sub' }, 'AI · knows your full profile')
            ),
            React.createElement('div', { style: { fontSize: 32 } }, '🤖')
          )
        ),
        React.createElement('div', { className: 'card', style: { marginTop: 16 } },
          React.createElement('div', { className: 'clbl' }, '🔑 Anthropic API Key'),
          React.createElement('div', { className: 'co amber', style: { margin: '0 0 14px' } },
            React.createElement('strong', { style: { color: 'var(--amber)' } }, editingKey ? 'Update API Key' : 'Setup Required'),
            React.createElement('br'),
            editingKey
              ? 'Enter a new key to replace the current one.'
              : 'The AI Coach needs your Anthropic API key to work. Your key is stored only on this device — never in the app code or GitHub.'
          ),
          React.createElement('div', { className: 'ig' },
            React.createElement('label', { className: 'ilbl' }, 'API Key (starts with sk-ant-)'),
            React.createElement('input', {
              className: 'inp',
              type: 'password',
              placeholder: 'sk-ant-...',
              value: keyDraft,
              onChange: e => setKeyDraft(e.target.value),
              onKeyDown: e => e.key === 'Enter' && saveKey(),
              autoComplete: 'off',
              spellCheck: false,
            })
          ),
          React.createElement('div', { style: { display: 'flex', gap: 10 } },
            editingKey && React.createElement('button', { className: 'btn ghost', onClick: () => { setEditingKey(false); setKeyDraft(''); } }, 'Cancel'),
            React.createElement('button', { className: 'btn full', onClick: saveKey, disabled: !keyDraft.trim().startsWith('sk-') }, 'Save Key')
          )
        ),
        React.createElement('div', { className: 'co blue', style: { marginTop: 4 } },
          React.createElement('strong', { style: { color: 'var(--blue)' } }, 'Get a free API key'),
          React.createElement('br'),
          React.createElement('a', { href: 'https://console.anthropic.com', target: '_blank', style: { color: 'var(--blue)' } }, 'console.anthropic.com'),
          ' → API Keys → Create Key. New accounts include free credits.'
        )
      );
    }

    // ── Main chat interface ───────────────────────────────────
    return React.createElement('div', null,
      React.createElement('div', { className: 'ph' },
        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
          React.createElement('div', null,
            React.createElement('div', { className: 'ph-title' }, 'COACH'),
            React.createElement('div', { className: 'ph-sub' }, 'AI · knows your full profile')
          ),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
            React.createElement('button', {
              onClick: () => { setEditingKey(true); setKeyDraft(''); },
              style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer', opacity: 0.5 },
              title: 'Update API key'
            }, '🔑'),
            React.createElement('div', { style: { fontSize: 32 } }, '🤖')
          )
        )
      ),
      msgs.length <= 1 && React.createElement('div', { style: { padding: '10px 16px 0', display: 'flex', flexWrap: 'wrap' } },
        SUGG.map((s, i) => React.createElement('span', { key: i, className: 'pill', onClick: () => send(s) }, s))
      ),
      React.createElement('div', { style: { padding: '12px 16px 0' } },
        msgs.map((m, i) => React.createElement('div', { key: i, className: `bubble fade ${m.role === 'user' ? 'user' : ''}` }, m.text)),
        loading && React.createElement('div', { className: 'bubble' },
          React.createElement('span', { className: 'spin', style: { width: 14, height: 14 } }),
          React.createElement('span', { style: { fontSize: 12, color: 'var(--t2)', marginLeft: 8 } }, 'Thinking...')
        )
      ),
      React.createElement('div', { style: { padding: '10px 16px', display: 'flex', gap: 8, position: 'sticky', bottom: 'calc(var(--nav) + 6px)' } },
        React.createElement('input', {
          className: 'inp',
          placeholder: 'Ask anything...',
          value: input,
          onChange: e => setInput(e.target.value),
          onKeyDown: e => e.key === 'Enter' && send()
        }),
        React.createElement('button', { className: 'btn', onClick: () => send(), disabled: loading || !input.trim() }, 'Send')
      )
    );
  }
  </script>

  <script>
    // Mount the app
    try {
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(React.createElement(App));
      // Hide boot screen after render
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          var boot = document.getElementById('boot');
          if (boot) {
            boot.style.opacity = '0';
            setTimeout(function() { if(boot.parentNode) boot.remove(); }, 400);
          }
        });
      });
    } catch(e) {
      document.getElementById('boot').style.display = 'none';
      document.getElementById('err').style.display = 'block';
      document.getElementById('errmsg').textContent = e.stack || e.message;
    }
  </script>
</body>
</html>
